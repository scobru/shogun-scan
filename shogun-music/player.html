<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shogun Music - Player</title>
    <script src="https://unpkg.com/wavesurfer.js@6.6.3/dist/wavesurfer.min.js"></script>
    <script src="./shogun-core.js"></script>

    <!-- Verifica caricamento di Shogun Core -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Verifica che Shogun Core sia caricato
        if (typeof window.initShogunBrowser === "undefined") {
          console.error("Shogun Core non è stato caricato correttamente.");
          const errorMsg = document.createElement("div");
          errorMsg.style.position = "fixed";
          errorMsg.style.top = "10px";
          errorMsg.style.left = "50%";
          errorMsg.style.transform = "translateX(-50%)";
          errorMsg.style.padding = "10px 20px";
          errorMsg.style.backgroundColor = "#e22134";
          errorMsg.style.color = "#ffffff";
          errorMsg.style.borderRadius = "4px";
          errorMsg.style.zIndex = "9999";
          errorMsg.textContent =
            "Impossibile caricare Shogun Core. Ricarica la pagina.";
          document.body.appendChild(errorMsg);
        }
      });
    </script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        color: #eaeaea;
        background-color: #121212;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      h1,
      h2,
      h3 {
        color: #ffffff;
      }
      /* Layout principale con sidebar */
      .main-container {
        display: flex;
        width: 100%;
        height: 100%;
      }
      .sidebar {
        width: 240px;
        background-color: #000000;
        padding: 20px;
        border-right: 1px solid #282828;
        overflow-y: auto;
        flex-shrink: 0;
      }
      .main-content {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        display: flex;
        flex-direction: column;
      }
      .content-area {
        padding: 20px;
        flex: 1;
        overflow-y: auto;
      }
      .status-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .server-status {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
      }
      .status-online {
        background-color: #1db954;
        color: #121212;
      }
      .status-offline {
        background-color: #e22134;
        color: #ffffff;
      }
      .status-warning {
        background-color: #f59b23;
        color: #121212;
      }
      .player-container,
      .playlist-container,
      .relay-container {
        background: #181818;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px;
      }
      button {
        background-color: #1db954;
        color: #121212;
        border: none;
        padding: 8px 16px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        border-radius: 20px;
        cursor: pointer;
        margin-right: 5px;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #1ed760;
      }
      #songsList {
        list-style-type: none;
        padding: 0;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        grid-gap: 16px;
      }
      .song-item {
        background-color: #282828;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        transition: background-color 0.3s;
        position: relative;
      }
      .song-item:hover {
        background-color: #333333;
      }
      .song-info {
        flex-grow: 1;
        margin-top: 12px;
      }
      .song-title {
        font-weight: bold;
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .song-artist {
        font-size: 14px;
        color: #a7a7a7;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .song-actions {
        margin-top: 12px;
        display: flex;
        gap: 5px;
      }
      .artwork {
        width: 100%;
        height: 170px;
        object-fit: cover;
        border-radius: 4px;
      }
      .artwork-placeholder {
        width: 100%;
        height: 170px;
        background-color: #333333;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: #888;
      }
      .player-controls {
        background-color: #181818;
        border-top: 1px solid #282828;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        flex-shrink: 0;
      }
      .play-btn,
      .pause-btn {
        background-color: #1db954;
        font-size: 16px;
        padding: 12px 16px;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .play-btn:hover,
      .pause-btn:hover {
        background-color: #1ed760;
        transform: scale(1.05);
      }
      .now-playing {
        margin-bottom: 20px;
        padding: 16px;
        background-color: #282828;
        border-radius: 8px;
        display: flex;
        align-items: center;
      }
      .now-playing-info {
        margin-left: 16px;
      }
      #waveform {
        width: 100%;
        height: 60px;
        background-color: #282828;
        border-radius: 4px;
      }
      .relay-input {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .relay-input input {
        flex-grow: 1;
        padding: 8px 16px;
        background-color: #333333;
        color: #eaeaea;
        border: 1px solid #444444;
        border-radius: 20px;
        box-sizing: border-box;
      }
      #relayList {
        list-style-type: none;
        padding: 0;
      }
      .relay-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #333333;
        font-size: 14px;
      }
      .relay-item button {
        margin-left: 10px;
        padding: 4px 8px;
        font-size: 12px;
      }
      .status-badge {
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 12px;
        margin-left: 10px;
      }
      .status-badge.online {
        background-color: #1db954;
        color: #121212;
      }
      .status-badge.offline {
        background-color: #e22134;
        color: #ffffff;
      }
      .status-badge.warning {
        background-color: #f59b23;
        color: #121212;
      }
      /* Stili per messaggi di caricamento e errore */
      .loading,
      .error,
      .empty-library {
        padding: 20px;
        text-align: center;
        background-color: #282828;
        border-radius: 8px;
        margin: 20px 0;
        width: 100%;
      }
      .loading {
        color: #1db954;
        animation: pulse 1.5s infinite ease-in-out;
      }
      .error {
        color: #e22134;
        border-left: 4px solid #e22134;
      }
      .empty-library {
        color: #a7a7a7;
        font-style: italic;
      }
      @keyframes pulse {
        0% {
          opacity: 0.6;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.6;
        }
      }
      .admin-link {
        margin-top: 20px;
        text-align: center;
      }
      .admin-link a {
        color: #a7a7a7;
        text-decoration: none;
        font-size: 14px;
      }
      .admin-link a:hover {
        color: #ffffff;
        text-decoration: underline;
      }
      /* Token input styling */
      #customToken {
        background-color: #333333;
        color: #eaeaea;
        border: 1px solid #444444;
        border-radius: 20px;
        padding: 8px 16px;
        width: 100%;
      }
      /* Filter styling */
      .filter-container {
        margin-bottom: 20px;
        padding: 16px;
        background-color: #282828;
        border-radius: 8px;
      }
      #filterType {
        padding: 8px 16px;
        background-color: #333333;
        color: #eaeaea;
        border: 1px solid #444444;
        border-radius: 20px;
      }
      #filterInput {
        flex-grow: 1;
        padding: 8px 16px;
        background-color: #333333;
        color: #eaeaea;
        border: 1px solid #444444;
        border-radius: 20px;
      }
      #clearFilterBtn {
        padding: 8px 16px;
        background-color: #333333;
        color: #eaeaea;
      }
      #clearFilterBtn:hover {
        background-color: #444444;
      }
      /* Stile per il controllo volume */
      #volumeSlider {
        -webkit-appearance: none;
        width: 100px;
        height: 4px;
        background: #555555;
        border-radius: 2px;
        margin-left: auto;
      }
      #volumeSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        background: #ffffff;
        border-radius: 50%;
        cursor: pointer;
      }
      .time-display {
        font-size: 14px;
        color: #a7a7a7;
        min-width: 80px;
        text-align: center;
      }
      .menu-item div {
        padding: 10px 0;
        color: #a7a7a7;
        transition: color 0.3s;
        cursor: pointer;
      }
      .menu-item div:hover {
        color: #ffffff;
      }
      /* Stili per l'autenticazione */
      .auth-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .auth-form {
        background-color: #282828;
        padding: 30px;
        border-radius: 8px;
        width: 400px;
        max-width: 90%;
      }
      .auth-logo {
        text-align: center;
        margin-bottom: 20px;
      }
      .auth-logo h1 {
        color: #1db954;
        margin: 0;
      }
      .auth-tabs {
        display: flex;
        margin-bottom: 20px;
      }
      .auth-tab {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
      }
      .auth-tab.active {
        border-bottom: 2px solid #1db954;
        color: #1db954;
      }
      .auth-input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        background-color: #333;
        border: none;
        border-radius: 4px;
        color: #fff;
        box-sizing: border-box;
      }
      .auth-button {
        width: 100%;
        padding: 12px;
        background-color: #1db954;
        color: #000;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
      }
      .auth-button:hover {
        background-color: #1ed760;
      }
      .auth-separator {
        display: flex;
        align-items: center;
        text-align: center;
        margin: 20px 0;
      }
      .auth-separator::before,
      .auth-separator::after {
        content: "";
        flex: 1;
        border-bottom: 1px solid #444;
      }
      .auth-separator span {
        padding: 0 10px;
        color: #888;
      }
      .auth-options {
        display: flex;
        gap: 10px;
      }
      .auth-option-button {
        flex: 1;
        padding: 10px;
        background-color: #333;
        border: 1px solid #444;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .auth-option-button:hover {
        background-color: #444;
      }
      .auth-form-group {
        margin-bottom: 15px;
      }
      .auth-error {
        color: #e74c3c;
        margin-top: -10px;
        margin-bottom: 15px;
        font-size: 14px;
      }
      .auth-success {
        color: #1db954;
        margin-top: -10px;
        margin-bottom: 15px;
        font-size: 14px;
      }
      .auth-hidden {
        display: none;
      }
      /* Stili per le playlist personali */
      .playlists-menu {
        margin-top: 10px;
      }
      .playlist-item {
        padding: 8px 0;
        color: #a7a7a7;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: color 0.2s;
      }
      .playlist-item:hover {
        color: #ffffff;
      }
      .playlist-item.active {
        color: #1db954;
      }
      .playlist-actions {
        margin-top: 10px;
      }
      .playlist-small-button {
        background-color: transparent;
        color: #a7a7a7;
        border: 1px solid #444;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        margin-left: 5px;
        padding: 0;
      }
      .playlist-small-button:hover {
        background-color: #333;
        color: #ffffff;
      }
      .playlist-create {
        display: flex;
        margin-top: 15px;
      }
      .playlist-create input {
        flex-grow: 1;
        background-color: #333;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 8px;
        color: #eaeaea;
        margin-right: 5px;
      }
      .favorites-section {
        margin-top: 20px;
      }
      .favorite-item {
        padding: 8px 0;
        color: #a7a7a7;
        cursor: pointer;
      }
      .favorite-item:hover {
        color: #ffffff;
      }
      /* Badge per conteggio elementi */
      .count-badge {
        background-color: #333;
        color: #a7a7a7;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 11px;
        margin-left: 5px;
      }
      /* Dropdown per le opzioni traccia */
      .track-dropdown {
        position: relative;
        display: inline-block;
      }
      .track-dropdown-content {
        display: none;
        position: absolute;
        background-color: #333;
        min-width: 160px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        z-index: 1;
        right: 0;
      }
      .track-dropdown:hover .track-dropdown-content {
        display: block;
      }
      .dropdown-item {
        color: #eaeaea;
        padding: 8px 16px;
        display: block;
        cursor: pointer;
        font-size: 14px;
      }
      .dropdown-item:hover {
        background-color: #444;
      }
      /* Tab di visualizzazione */
      .content-tabs {
        display: flex;
        border-bottom: 1px solid #333;
        margin-bottom: 20px;
      }
      .content-tab {
        padding: 12px 20px;
        cursor: pointer;
        color: #a7a7a7;
        border-bottom: 2px solid transparent;
      }
      .content-tab.active {
        color: #1db954;
        border-bottom: 2px solid #1db954;
      }
      .content-tab:hover {
        color: #ffffff;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
      <div class="auth-form">
        <div class="auth-logo">
          <h1>Shogun Music</h1>
          <p>Accedi per ascoltare la tua musica</p>
        </div>
        <div class="auth-tabs">
          <div class="auth-tab active" data-tab="login">Accedi</div>
          <div class="auth-tab" data-tab="signup">Registrati</div>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="auth-form-content">
          <div class="auth-form-group">
            <input
              type="text"
              id="loginUsername"
              class="auth-input"
              placeholder="Username"
            />
          </div>
          <div class="auth-form-group">
            <input
              type="password"
              id="loginPassword"
              class="auth-input"
              placeholder="Password"
            />
          </div>
          <div id="loginError" class="auth-error auth-hidden"></div>
          <div id="loginSuccess" class="auth-success auth-hidden"></div>
          <button id="loginButton" class="auth-button">Accedi</button>

          <div class="auth-separator">
            <span>OPPURE</span>
          </div>

          <div class="auth-options">
            <button id="webauthnLoginBtn" class="auth-option-button">
              <span>WebAuthn</span>
            </button>
            <button id="metamaskLoginBtn" class="auth-option-button">
              <span>MetaMask</span>
            </button>
          </div>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" class="auth-form-content auth-hidden">
          <div class="auth-form-group">
            <input
              type="text"
              id="signupUsername"
              class="auth-input"
              placeholder="Username"
            />
          </div>
          <div class="auth-form-group">
            <input
              type="password"
              id="signupPassword"
              class="auth-input"
              placeholder="Password"
            />
          </div>
          <div class="auth-form-group">
            <input
              type="password"
              id="signupPasswordConfirm"
              class="auth-input"
              placeholder="Conferma password"
            />
          </div>
          <div id="signupError" class="auth-error auth-hidden"></div>
          <div id="signupSuccess" class="auth-success auth-hidden"></div>
          <button id="signupButton" class="auth-button">Registrati</button>

          <div class="auth-separator">
            <span>OPPURE</span>
          </div>

          <div class="auth-options">
            <button id="webauthnSignupBtn" class="auth-option-button">
              <span>WebAuthn</span>
            </button>
            <button id="metamaskSignupBtn" class="auth-option-button">
              <span>MetaMask</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main App Content -->
    <div class="main-container" id="appContainer" style="display: none">
      <div class="sidebar">
        <h2>Shogun Music</h2>

        <div style="margin: 30px 0">
          <h3>Il tuo Profilo</h3>
          <div class="menu-item">
            <div>
              <span id="userProfileUsername">Utente</span>
            </div>
            <div>
              <span>La tua libreria</span>
            </div>
            <div>
              <button id="logoutBtn" style="width: 100%; margin-top: 10px">
                Logout
              </button>
            </div>
          </div>
        </div>

        <div style="margin: 30px 0">
          <h3>Server Status</h3>
          <div class="status-container">
            <div id="serverStatus" class="server-status status-offline">
              Server offline
            </div>
            <div id="gunStatus" class="server-status status-offline">
              GUN offline
            </div>
          </div>
        </div>

        

        <div class="favorites-section">
          <h3>Preferiti</h3>
          <div class="menu-item">
            <div class="favorite-item" data-section="favorite-songs">
              <span>Brani</span>
              <span class="count-badge" id="favoriteSongsCount">0</span>
            </div>
            <div class="favorite-item" data-section="favorite-artists">
              <span>Artisti</span>
              <span class="count-badge" id="favoriteArtistsCount">0</span>
            </div>
            <div class="favorite-item" data-section="favorite-albums">
              <span>Album</span>
              <span class="count-badge" id="favoriteAlbumsCount">0</span>
            </div>
          </div>
        </div>

        <div class="playlists-section" style="margin: 30px 0">
          <h3>Le tue Playlist</h3>
          <div class="playlists-menu" id="playlistsMenu">
            <!-- Le playlist verranno aggiunte qui dinamicamente -->
          </div>
          <div class="playlist-create">
            <input
              type="text"
              id="newPlaylistName"
              placeholder="Nuova playlist..."
            />
            <button class="playlist-small-button" id="createPlaylistBtn">
              +
            </button>
          </div>
        </div>

        <div style="margin: 30px 0">
          <h3>Relay</h3>
          <p>Aggiungi relay per connetterti ad altri nodi Gun.js</p>
          <div class="relay-input">
            <input
              type="text"
              id="relayInput"
              placeholder="URL relay (es. https://gun-relay.example.com/gun)"
            />
            <button id="addRelayBtn">Aggiungi</button>
          </div>
          <ul id="relayList"></ul>
        </div>
      </div>

      <div class="main-content">
        <div class="content-area">
          <div class="player-container">
            <h2>Player</h2>
            <div id="nowPlaying" class="now-playing" style="display: none">
              <div id="nowPlayingArtwork" class="artwork-placeholder">♪</div>
              <div class="now-playing-info">
                <div id="nowPlayingTitle" class="song-title">
                  Nessuna traccia
                </div>
                <div id="nowPlayingArtist" class="song-artist">
                  Nessun artista
                </div>
              </div>
            </div>

            <div id="waveform"></div>
          </div>

          <div class="playlist-container">
            <div class="content-tabs">
              <div class="content-tab active" data-tab="all-tracks">
                Libreria
              </div>
              <div class="content-tab" data-tab="playlists">
                Le tue Playlist
              </div>
              <div class="content-tab" data-tab="favorites">Preferiti</div>
            </div>

            <!-- Tab Libreria -->
            <div class="tab-content active" id="all-tracks-tab">
              <h2>Libreria Completa</h2>

              <!-- Filtri -->
              <div class="filter-container">
                <div
                  style="
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    margin-bottom: 8px;
                  "
                >
                  <select id="filterType">
                    <option value="all">Tutto</option>
                    <option value="title">Titolo</option>
                    <option value="artist">Artista</option>
                    <option value="album">Album</option>
                  </select>
                  <input type="text" id="filterInput" placeholder="Cerca..." />
                  <button id="clearFilterBtn">Pulisci</button>
                </div>
                <div
                  id="filterStatus"
                  style="font-size: 13px; color: #a7a7a7"
                ></div>
              </div>

              <div id="songsLoading" class="loading">
                Caricamento tracce in corso...
              </div>
              <div id="songsError" class="error" style="display: none">
                Errore nel caricamento delle tracce
              </div>
              <div id="songsEmpty" class="empty-library" style="display: none">
                Nessuna traccia disponibile. Vai alla pagina di Admin per
                caricare musica.
              </div>
              <ul id="songsList"></ul>
            </div>

            <!-- Tab Playlist -->
            <div class="tab-content" id="playlists-tab">
              <div id="playlistHeader">
                <h2 id="currentPlaylistName">Seleziona una playlist</h2>
                <div
                  id="playlistInfo"
                  style="color: #a7a7a7; margin-bottom: 20px; display: none"
                >
                  <span id="playlistTrackCount">0 brani</span> •
                  <span id="playlistDuration">0 min</span>
                </div>
              </div>

              <div id="playlistEmpty" class="empty-library">
                Seleziona una playlist dalla barra laterale o creane una nuova
              </div>

              <ul id="playlistSongsList"></ul>
            </div>

            <!-- Tab Preferiti -->
            <div class="tab-content" id="favorites-tab">
              <div id="favoritesHeader">
                <h2 id="currentFavoriteSection">I tuoi Preferiti</h2>
              </div>

              <!-- Sezione brani preferiti -->
              <div id="favoriteSongsSection">
                <h3>Brani preferiti</h3>
                <div id="favoriteSongsEmpty" class="empty-library">
                  Non hai ancora brani preferiti
                </div>
                <ul id="favoriteSongsList"></ul>
              </div>

              <!-- Sezione artisti preferiti -->
              <div id="favoriteArtistsSection">
                <h3>Artisti preferiti</h3>
                <div id="favoriteArtistsEmpty" class="empty-library">
                  Non hai ancora artisti preferiti
                </div>
                <ul id="favoriteArtistsList"></ul>
              </div>

              <!-- Sezione album preferiti -->
              <div id="favoriteAlbumsSection">
                <h3>Album preferiti</h3>
                <div id="favoriteAlbumsEmpty" class="empty-library">
                  Non hai ancora album preferiti
                </div>
                <ul id="favoriteAlbumsList"></ul>
              </div>
            </div>
          </div>
        </div>

        <div class="player-controls">
          <button id="playBtn" class="play-btn" disabled>▶</button>
          <button
            id="pauseBtn"
            class="pause-btn"
            disabled
            style="display: none"
          >
            ❚❚
          </button>
          <div class="time-display">
            <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
          </div>
          <div
            id="waveformMini"
            style="
              flex-grow: 1;
              height: 4px;
              background: #555;
              border-radius: 2px;
            "
          ></div>
          <input
            type="range"
            id="volumeSlider"
            min="0"
            max="1"
            step="0.01"
            value="0.7"
          />
        </div>
      </div>
    </div>

    <script>
      // Variabili globali
      let userPlaylists = [];
      let userFavorites = { songs: [], artists: [], albums: [] };
      let tracks = []; // Definito come variabile globale per accesso da altre funzioni
      let allTracks = []; // Per mantenere un riferimento a tutte le tracce caricate

      // Variabile per tracciare la playlist corrente
      let currentPlaylistId = null;

      // Funzione per aggiornare i contatori dei preferiti
      function updateFavoriteCounts() {
        if (!userFavorites) {
          userFavorites = { songs: [], artists: [], albums: [] };
        }

        const favoriteSongsCount =
          document.getElementById("favoriteSongsCount");
        const favoriteArtistsCount = document.getElementById(
          "favoriteArtistsCount"
        );
        const favoriteAlbumsCount = document.getElementById(
          "favoriteAlbumsCount"
        );

        if (favoriteSongsCount)
          favoriteSongsCount.textContent = userFavorites.songs
            ? userFavorites.songs.length
            : 0;
        if (favoriteArtistsCount)
          favoriteArtistsCount.textContent = userFavorites.artists
            ? userFavorites.artists.length
            : 0;
        if (favoriteAlbumsCount)
          favoriteAlbumsCount.textContent = userFavorites.albums
            ? userFavorites.albums.length
            : 0;
      }

      // Funzione per salvare le playlist dell'utente in GunDB
      function saveUserPlaylistsToGun() {
        if (!window.shogun || !window.shogun.isLoggedIn()) {
          console.warn("Impossibile salvare playlist: utente non autenticato");
          return;
        }

        try {
          console.log("Salvataggio playlist in GunDB...");
          
          // Verifica che userPlaylists sia effettivamente un array
          if (!Array.isArray(userPlaylists)) {
            console.warn("userPlaylists non è un array, inizializzazione");
            userPlaylists = [];
          }
          
          // Filtra le playlist valide prima di salvarle
          const validPlaylists = userPlaylists.filter(
            playlist => playlist && typeof playlist === 'object' && playlist.id && playlist.name
          );
          
          console.log("Numero playlist valide da salvare:", validPlaylists.length);
          
          // Converti le playlist in formato compatibile con GunDB
          const playlistsObj = {};
          validPlaylists.forEach((playlist, index) => {
            // Per ogni playlist, se contiene un array 'tracks', convertilo in oggetto
            try {
              if (playlist.tracks && Array.isArray(playlist.tracks)) {
                playlistsObj[index] = {
                  ...playlist,
                  tracks: arrayToGunObject(playlist.tracks)
                };
              } else {
                playlistsObj[index] = {
                  ...playlist,
                  tracks: {} // Assicurati che ci sia almeno un oggetto vuoto
                };
              }
              
              // Log per debug
              console.log(`Playlist ${index}:`, playlist.name, 
                        "ID:", playlist.id, 
                        "Tracce:", playlist.tracks ? playlist.tracks.length : 0);
            } catch (e) {
              console.error(`Errore durante la conversione della playlist ${index}:`, e);
            }
          });
          
          // Log per debug dell'oggetto completo
          console.log("Oggetto playlist da salvare:", JSON.stringify(playlistsObj));
          
          // Se non ci sono playlist da salvare, salva un oggetto vuoto per evitare problemi
          if (Object.keys(playlistsObj).length === 0) {
            console.log("Nessuna playlist valida da salvare, salvo un oggetto vuoto");
            window.shogun.gun
              .user()
              .get("playlists")
              .put({}, (ack) => {
                console.log("Risposta salvataggio playlist vuote:", ack);
                if (ack.err) {
                  console.error("Errore nel salvataggio playlist vuote:", ack.err);
                } else {
                  console.log("Playlist vuote salvate con successo");
                }
              });
            return;
          }
          
          // Usa l'istanza Gun esposta con callback esplicito
          window.shogun.gun
            .user()
            .get("playlists")
            .put(playlistsObj, (ack) => {
              console.log("Risposta salvataggio playlist:", ack);
              if (ack.err) {
                console.error(
                  "Errore nel salvataggio playlist in GunDB:",
                  ack.err
                );
              } else {
                console.log(
                  "Playlist salvate con successo in GunDB:",
                  Object.keys(playlistsObj).length
                );
                
                // Verifica del salvataggio
                setTimeout(() => {
                  window.shogun.gun.user().get("playlists").once((data) => {
                    console.log("Verifica salvataggio playlist - dati salvati:", data);
                    
                    // Aggiorna l'interfaccia dopo il salvataggio confermato
                    displayPlaylists();
                  });
                }, 500);
              }
            });
        } catch (error) {
          console.error(
            "Errore durante il salvataggio playlist in GunDB:",
            error
          );
        }
      }

      // Funzione per salvare i preferiti dell'utente in GunDB
      function saveUserFavoritesToGun() {
        if (!window.shogun) {
          console.warn("Impossibile salvare preferiti: Shogun non inizializzato");
          return;
        }

        // Controlla se l'utente è autenticato
        const isLoggedIn = window.shogun.isLoggedIn && window.shogun.isLoggedIn();
        const isUserAuthenticated = window.shogun.gun && window.shogun.gun.user().is;

        if (!isLoggedIn || !isUserAuthenticated) {
          console.warn("Impossibile salvare preferiti: utente non autenticato");
          return;
        }

        console.log("Salvataggio preferiti in GunDB...");

        try {
          // Converti gli array in oggetti per GunDB
          const favoritesObj = {
            songs: arrayToGunObject(userFavorites.songs || []),
            artists: arrayToGunObject(userFavorites.artists || []),
            albums: arrayToGunObject(userFavorites.albums || []),
          };

          // Stampa l'oggetto per debug
          console.log("Oggetto preferiti da salvare:", JSON.stringify(favoritesObj));

          // Usa put() direttamente sull'oggetto favorites con callback per verificare il salvataggio
          window.shogun.gun.user().get("favorites").put(favoritesObj, (ack) => {
            console.log("Risposta salvataggio preferiti:", ack);
            if (ack.err) {
              console.error("Errore nel salvataggio dei preferiti:", ack.err);
            } else {
              console.log(
                "Preferiti salvati con successo in GunDB:",
                "Brani:",
                userFavorites.songs?.length || 0,
                "Artisti:",
                userFavorites.artists?.length || 0,
                "Album:",
                userFavorites.albums?.length || 0
              );
              
              // Verifica immediata che il salvataggio sia avvenuto correttamente
              setTimeout(() => {
                window.shogun.gun.user().get("favorites").once((data) => {
                  console.log("Verifica salvataggio preferiti - dati salvati:", data);
                });
              }, 500);
            }
          });

        } catch (error) {
          console.error(
            "Errore durante il salvataggio preferiti in GunDB:",
            error
          );
        }
      }
      
      // Funzione di utilità per convertire un array in un oggetto compatibile con GunDB
      function arrayToGunObject(arr) {
        if (!Array.isArray(arr)) return {};
        
        const obj = {};
        arr.forEach((item, index) => {
          obj[index] = item;
        });
        return obj;
      }
      
      // Funzione di utilità per convertire un oggetto GunDB in array
      function gunObjectToArray(obj) {
        if (!obj || typeof obj !== 'object') return [];
        
        // Filtra le proprietà che non sono indici numerici o metadati di Gun
        return Object.keys(obj)
          .filter(key => !isNaN(Number(key)) && key !== '_' && obj[key] !== null)
          .map(key => obj[key]);
      }

      // Funzione per caricare le playlist dell'utente da GunDB
      function loadUserPlaylistsFromGun() {
        if (!window.shogun || !window.shogun.isLoggedIn()) {
          console.warn("Impossibile caricare playlist: utente non autenticato");
          return Promise.resolve(false);
        }

        console.log("Tentativo di caricamento playlist da GunDB...");
        
        return new Promise((resolve) => {
          let resolved = false;
          
          try {
            const userAlias = window.shogun.gun.user()._.alias || "Non disponibile";
            console.log("GunDB user:", userAlias);
            
            window.shogun.gun
              .user()
              .get("playlists")
              .once((data) => {
                console.log("Risposta GunDB (playlists):", data);
                
                if (data && !resolved) {
                  try {
                    // Inizializza l'array delle playlist
                    let loadedPlaylists = [];
                    
                    // Converti i dati GunDB in array
                    if (typeof data === 'object' && data !== null) {
                      const playlistArr = gunObjectToArray(data);
                      
                      // Filtra le playlist valide
                      loadedPlaylists = playlistArr.filter(playlist => 
                        playlist && 
                        typeof playlist === 'object' &&
                        playlist.id && 
                        playlist.name
                      );
                      
                      // Per ogni playlist valida, assicurati che le tracce siano un array
                      loadedPlaylists.forEach(playlist => {
                        console.log(`Elaborazione playlist '${playlist.name}':`, playlist);
                        
                        if (playlist.tracks && typeof playlist.tracks === 'object') {
                          playlist.tracks = gunObjectToArray(playlist.tracks);
                          console.log("Tracce convertite da oggetto a array:", playlist.tracks);
                        } else if (!playlist.tracks || !Array.isArray(playlist.tracks)) {
                          playlist.tracks = [];
                          console.log("Inizializzato array tracce vuoto");
                        }
                      });
                    }

                    if (loadedPlaylists.length > 0) {
                      userPlaylists = loadedPlaylists;
                      console.log(
                        "Playlist caricate da GunDB:",
                        userPlaylists.length
                      );
                      
                      // Log dettagliato di ogni playlist
                      userPlaylists.forEach((playlist, index) => {
                        console.log(`Playlist ${index}: ${playlist.name}, ID: ${playlist.id}, Tracce: ${playlist.tracks ? playlist.tracks.length : 0}`);
                      });
                      
                      resolved = true;
                      resolve(true);
                    } else {
                      console.log("Nessuna playlist valida trovata in GunDB");
                      userPlaylists = []; // Assicurati che sia un array vuoto, non undefined
                      resolved = true;
                      resolve(false);
                    }
                  } catch (parseError) {
                    console.error("Errore durante la conversione delle playlist:", parseError);
                    userPlaylists = []; // Assicurati che sia un array vuoto in caso di errore
                    resolved = true;
                    resolve(false);
                  }
                } else if (!resolved) {
                  console.log("Nessun dato playlist trovato in GunDB");
                  userPlaylists = []; // Assicurati che sia un array vuoto
                  resolved = true;
                  resolve(false);
                }
              });
            
            // Aggiungi un timeout per evitare blocchi indefiniti
            setTimeout(() => {
              if (!resolved) {
                console.warn("Timeout nel caricamento delle playlist da GunDB.");
                userPlaylists = []; // Assicurati che sia un array vuoto
                resolved = true;
                resolve(false);
              }
            }, 5000);
            
          } catch (error) {
            console.error(
              "Errore durante il caricamento playlist da GunDB:",
              error
            );
            userPlaylists = []; // Assicurati che sia un array vuoto
            if (!resolved) {
              resolved = true;
              resolve(false);
            }
          }
        });
      }

      // Funzione per caricare i preferiti dell'utente da GunDB
      function loadUserFavoritesFromGun() {
        if (!window.shogun) {
          console.warn("Impossibile caricare preferiti: Shogun non inizializzato");
          return Promise.resolve(false);
        }

        // Controlla se l'utente è autenticato
        const isLoggedIn = window.shogun.isLoggedIn && window.shogun.isLoggedIn();
        const isUserAuthenticated = window.shogun.gun && window.shogun.gun.user().is;
        
        if (!isLoggedIn || !isUserAuthenticated) {
          console.warn("Impossibile caricare preferiti: utente non autenticato");
          return Promise.resolve(false);
        }

        console.log("Tentativo di caricamento preferiti da GunDB...");
        
        return new Promise((resolve) => {
          let resolved = false;
          let favoritesData = {
            songs: [],
            artists: [],
            albums: []
          };
          
          try {
            const userAlias = window.shogun.gun.user()._.alias || "Non disponibile";
            console.log("GunDB user:", userAlias);
            
            // Prima leggiamo il nodo favorites per verificare se esiste
            window.shogun.gun
              .user()
              .get("favorites")
              .once((data) => {
                console.log("Lettura iniziale nodo favorites:", data);
                
                if (!data) {
                  console.log("Nessun dato preferiti trovato");
                  resolved = true;
                  resolve(false);
                  return;
                }
                
                // Estrai ognuna delle categorie separatamente per evitare errori di nesting
                if (data.songs) {
                  window.shogun.gun
                    .user()
                    .get("favorites")
                    .get("songs")
                    .once((songsData) => {
                      console.log("Dati delle canzoni preferite:", songsData);
                      if (songsData && typeof songsData === 'object') {
                        favoritesData.songs = gunObjectToArray(songsData);
                      }
                      checkIfComplete();
                    });
                } else {
                  checkIfComplete();
                }
                
                if (data.artists) {
                  window.shogun.gun
                    .user()
                    .get("favorites")
                    .get("artists")
                    .once((artistsData) => {
                      console.log("Dati degli artisti preferiti:", artistsData);
                      if (artistsData && typeof artistsData === 'object') {
                        favoritesData.artists = gunObjectToArray(artistsData);
                      }
                      checkIfComplete();
                    });
                } else {
                  checkIfComplete();
                }
                
                if (data.albums) {
                  window.shogun.gun
                    .user()
                    .get("favorites")
                    .get("albums")
                    .once((albumsData) => {
                      console.log("Dati degli album preferiti:", albumsData);
                      if (albumsData && typeof albumsData === 'object') {
                        favoritesData.albums = gunObjectToArray(albumsData);
                      }
                      checkIfComplete();
                    });
                } else {
                  checkIfComplete();
                }
              });
            
            // Funzione per verificare se tutte le letture sono complete
            let checkCount = 0;
            function checkIfComplete() {
              checkCount++;
              console.log(`Controllo completezza dati: ${checkCount}/3`);
              
              if (checkCount >= 3 && !resolved) {
                userFavorites = favoritesData;
                
                console.log(
                  "Preferiti caricati da GunDB:",
                  "Brani:",
                  userFavorites.songs?.length || 0,
                  "Artisti:",
                  userFavorites.artists?.length || 0,
                  "Album:",
                  userFavorites.albums?.length || 0
                );
                
                // Aggiorna i contatori nell'interfaccia
                updateFavoriteCounts();
                
                // Aggiorna la visualizzazione dei preferiti se visibili
                updateFavoritesDisplay();
                
                resolved = true;
                resolve(true);
              }
            }

            // Aggiungi un timeout per evitare blocchi indefiniti
            setTimeout(() => {
              if (!resolved) {
                console.warn("Timeout nel caricamento dei preferiti da GunDB. Nessun dato ricevuto.");
                
                // In caso di timeout, usiamo i dati parziali raccolti finora
                userFavorites = favoritesData;
                updateFavoriteCounts();
                updateFavoritesDisplay();
                
                resolved = true;
                resolve(false);
              }
            }, 5000);

          } catch (error) {
            console.error("Errore durante il caricamento preferiti da GunDB:", error);
            if (!resolved) {
              resolved = true;
              resolve(false);
            }
          }
        });
      }

      // Funzione helper per aggiornare le viste dei preferiti 
      function updateFavoritesDisplay() {
        const favoritesTab = document.querySelector('.content-tab[data-tab="favorites"]');
        const favoritesTabContent = document.getElementById('favorites-tab');
        
        if (favoritesTab && 
            favoritesTab.classList.contains("active") && 
            favoritesTabContent && 
            favoritesTabContent.classList.contains("active")) {
          
          // Aggiorna le singole sezioni se visibili
          if (document.getElementById('favoriteSongsSection').style.display !== 'none') {
            displayFavoriteSongs();
          }
          
          // Aggiungi logica per artists e albums se necessario
          if (document.getElementById('favoriteArtistsSection').style.display !== 'none') {
            // displayFavoriteArtists();
          }
          
          if (document.getElementById('favoriteAlbumsSection').style.display !== 'none') {
            // displayFavoriteAlbums();
          }
        }
      }

      // Carica i dati salvati all'inizio
      document.addEventListener("DOMContentLoaded", function () {
        // Configurazione iniziale
        userPlaylists = [];
        userFavorites = { songs: [], artists: [], albums: [] };
      });

      // Logica di autenticazione
      document.addEventListener("DOMContentLoaded", function () {
        // Riferimenti agli elementi DOM di autenticazione
        const authContainer = document.getElementById("authContainer");
        const appContainer = document.getElementById("appContainer");
        const authTabs = document.querySelectorAll(".auth-tab");
        const loginForm = document.getElementById("loginForm");
        const signupForm = document.getElementById("signupForm");

        // Username/password login/signup
        const loginUsername = document.getElementById("loginUsername");
        const loginPassword = document.getElementById("loginPassword");
        const loginButton = document.getElementById("loginButton");
        const loginError = document.getElementById("loginError");
        const loginSuccess = document.getElementById("loginSuccess");

        const signupUsername = document.getElementById("signupUsername");
        const signupPassword = document.getElementById("signupPassword");
        const signupPasswordConfirm = document.getElementById(
          "signupPasswordConfirm"
        );
        const signupButton = document.getElementById("signupButton");
        const signupError = document.getElementById("signupError");
        const signupSuccess = document.getElementById("signupSuccess");

        // WebAuthn buttons
        const webauthnLoginBtn = document.getElementById("webauthnLoginBtn");
        const webauthnSignupBtn = document.getElementById("webauthnSignupBtn");

        // MetaMask buttons
        const metamaskLoginBtn = document.getElementById("metamaskLoginBtn");
        const metamaskSignupBtn = document.getElementById("metamaskSignupBtn");

        // Inizializzazione di Shogun Core
        function initShogun() {
          try {
            // Configurazione per Shogun Core
            const shogunConfig = {
              gundb: {
                peers: ["http://localhost:3000/gun"],
                localStorage: false,  // Abilita localStorage per migliorare la persistenza
                radisk: false,        // Abilita radisk per storage più affidabile
                authToken: "thisIsTheTokenForReals"
              },
              webauthn: {
                enabled: true,
              },
              metamask: {
                enabled: true,
              },
              did: {
                timeout: 30000 // 30 secondi di timeout per le operazioni DID
              }
            };

            // Inizializza Shogun Core con la configurazione
            window.shogun = window.initShogunBrowser(shogunConfig);

            console.log(
              "Shogun Core inizializzato con successo",
              window.shogun
            );

            // Gestione eventi
            if (window.shogun.isLoggedIn()) {
              console.log("Utente già autenticato:", window.shogun.gun.user()._.alias || "Utente senza nome");
              authContainer.style.display = "none";
              appContainer.style.display = "flex";

              // Aggiorna il nome utente nel profilo
              updateUserProfile();

              // Inizializza il contenuto utente
              initUserContent();
            } else {
              console.log("Utente non autenticato. Mostra schermata di login.");
              authContainer.style.display = "flex";
              appContainer.style.display = "none";
            }

            // Verifica se WebAuthn è supportato
            if (webauthnLoginBtn && webauthnSignupBtn) {
              const isWebAuthnSupported = window.shogun.isWebAuthnSupported();

              if (!isWebAuthnSupported) {
                console.log("WebAuthn non supportato dal browser");
                webauthnLoginBtn.style.opacity = "0.5";
                webauthnSignupBtn.style.opacity = "0.5";
                webauthnLoginBtn.title =
                  "WebAuthn non supportato dal tuo browser";
                webauthnSignupBtn.title =
                  "WebAuthn non supportato dal tuo browser";
              }
            }

            // Verifica se MetaMask è disponibile
            if (metamaskLoginBtn && metamaskSignupBtn) {
              const isMetaMaskAvailable = window.ethereum !== undefined;

              if (!isMetaMaskAvailable) {
                console.log("MetaMask non disponibile");
                metamaskLoginBtn.style.opacity = "0.5";
                metamaskSignupBtn.style.opacity = "0.5";
                metamaskLoginBtn.title =
                  "MetaMask non disponibile. Installa l'estensione MetaMask";
                metamaskSignupBtn.title =
                  "MetaMask non disponibile. Installa l'estensione MetaMask";
              }
            }
          } catch (error) {
            console.error(
              "Errore durante l'inizializzazione di Shogun Core:",
              error
            );
          }
        }

        // Funzione per aggiornare il profilo utente
        function updateUserProfile() {
          const userProfileUsername = document.getElementById(
            "userProfileUsername"
          );
          if (userProfileUsername) {
            if (window.shogun.gun && window.shogun.gun.user().is) {
              userProfileUsername.textContent =
                window.shogun.gun.user()._.alias || "Utente";
            }
          }
        }

        // Verifica se Shogun Core è già caricato
        if (typeof window.initShogunBrowser !== "undefined") {
          initShogun();
        } else {
          // Se non è caricato, aggiungi un listener per quando sarà disponibile
          document.addEventListener("shogun:loaded", initShogun);
        }

        // Funzione per inizializzare il contenuto utente
        function initUserContent() {
          console.log("Inizializzazione contenuti utente...");
          
          // Inizializza le strutture dati
          userPlaylists = [];
          userFavorites = { songs: [], artists: [], albums: [] };
          
          // Verifica se l'utente è autenticato
          if (window.shogun && window.shogun.gun && window.shogun.gun.user().is) {
            console.log("Utente autenticato con successo:", window.shogun.gun.user()._.alias);
          } else {
            console.warn("Inizializzazione contenuti ma utente non autenticato correttamente!");
            // Tentativo di riautenticazione
            if (window.shogun) {
              console.log("Tentativo di riconnessione al database...");
              try {
                window.shogun.gun.user().recall({sessionStorage: true});
              } catch (e) {
                console.error("Errore durante il tentativo di riconnessione:", e);
              }
            }
          }

          // Carica dati da GunDB con un controllo più robusto
          Promise.all([
            new Promise(resolve => {
              loadUserPlaylistsFromGun()
                .then(resolve)
                .catch(err => {
                  console.error("Errore caricamento playlist:", err);
                  userPlaylists = []; // Assicurati che sia un array vuoto
                  resolve(false);
                });
            }),
            new Promise(resolve => {
              loadUserFavoritesFromGun()
                .then(resolve)
                .catch(err => {
                  console.error("Errore caricamento preferiti:", err);
                  resolve(false);
                });
            })
          ])
          .then(([playlistsLoaded, favoritesLoaded]) => {
            console.log("Risultato caricamento dati:", {playlistsLoaded, favoritesLoaded});
            
            // Dopo il caricamento, aggiorna l'interfaccia
            updateFavoriteCounts();
            displayPlaylists();
            setupContentTabs();

            // Gestione click sui preferiti nella sidebar
            document.querySelectorAll(".favorite-item").forEach((item) => {
              const section = item.getAttribute("data-section");
              const type = section.split("-")[1]; // 'favorite-songs' -> 'songs'

              item.addEventListener("click", () => {
                displayFavorites(type);
              });
            });

            // Gestione creazione playlist
            const createPlaylistBtn = document.getElementById("createPlaylistBtn");
            if (createPlaylistBtn) {
              createPlaylistBtn.addEventListener("click", () => {
                const newPlaylistName = document
                  .getElementById("newPlaylistName")
                  .value.trim();
                if (newPlaylistName) {
                  createPlaylist(newPlaylistName);
                  document.getElementById("newPlaylistName").value = "";
                } else {
                  alert("Inserisci un nome per la playlist");
                }
              });
            }

            // Permetti di premere Enter per creare playlist
            const newPlaylistInput = document.getElementById("newPlaylistName");
            if (newPlaylistInput) {
              newPlaylistInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                  const newPlaylistName = newPlaylistInput.value.trim();
                  if (newPlaylistName) {
                    createPlaylist(newPlaylistName);
                    newPlaylistInput.value = "";
                  } else {
                    alert("Inserisci un nome per la playlist");
                  }
                }
              });
            }

            console.log("Inizializzazione contenuti utente completata");

            // Carica le tracce
            loadTracks();
          })
          .catch((error) => {
            console.error("Errore durante il caricamento dati:", error);
            // Carica comunque le tracce anche in caso di errore
            loadTracks();
          });
        }

        // Funzione per caricare le tracce musicali
        async function loadTracks() {
          try {
            console.log("Caricamento delle tracce in corso...");
            
            // URL dell'API di esempio per caricare le tracce
            const tracksURL = "http://localhost:3000/api/tracks";
            
            // Array di tracce di esempio (utilizzato se non è possibile caricare le tracce dall'API)
            const exampleTracks = [
              {
                id: "1",
                title: "Esempio Brano 1",
                artist: "Artista Esempio",
                album: "Album Esempio",
                duration: 180,
                artwork_path: "/assets/default-artwork.jpg"
              },
              {
                id: "2",
                title: "Esempio Brano 2",
                artist: "Artista Esempio",
                album: "Album Esempio",
                duration: 210,
                artwork_path: "/assets/default-artwork.jpg"
              },
              {
                id: "3",
                title: "Esempio Brano 3",
                artist: "Altro Artista",
                album: "Altro Album",
                duration: 240,
                artwork_path: "/assets/default-artwork.jpg"
              }
            ];
            
            let loadedTracks = [];
            
            try {
              // Tenta di caricare le tracce dall'API
              const response = await fetch(tracksURL);
              if (response.ok) {
                const data = await response.json();
                
                // Verifica che i dati ricevuti siano in formato array
                if (Array.isArray(data)) {
                  loadedTracks = data;
                } else if (data && typeof data === 'object') {
                  // Se è un oggetto, controlla se ha una proprietà che contiene le tracce
                  if (data.tracks && Array.isArray(data.tracks)) {
                    loadedTracks = data.tracks;
                  } else if (data.data && Array.isArray(data.data)) {
                    loadedTracks = data.data;
                  } else {
                    // Converte l'oggetto in array se possibile
                    const possibleTracks = Object.values(data).filter(item => 
                      item && typeof item === 'object' && 'title' in item && 'artist' in item
                    );
                    
                    if (possibleTracks.length > 0) {
                      loadedTracks = possibleTracks;
                    } else {
                      throw new Error("Formato dei dati ricevuti non valido");
                    }
                  }
                } else {
                  throw new Error("Formato dei dati ricevuti non valido");
                }
                
                console.log("Tracce caricate dall'API:", loadedTracks.length);
              } else {
                throw new Error("Impossibile caricare le tracce dall'API");
              }
            } catch (apiError) {
              console.warn("Errore nel caricamento tracce dall'API:", apiError.message);
              console.log("Utilizzo tracce di esempio");
              loadedTracks = exampleTracks;
            }
            
            // Verifica finale che loadedTracks sia un array prima di assegnarlo
            if (!Array.isArray(loadedTracks)) {
              console.warn("Il formato dei dati delle tracce non è un array. Utilizzo tracce di esempio.");
              loadedTracks = exampleTracks;
            }
            
            // Assegna alle variabili globali
            tracks = loadedTracks;
            allTracks = [...loadedTracks]; // Copia per riferimento futuro
            
            console.log("Tracce caricate globalmente:", tracks.length);
            
            // Visualizza le tracce nell'interfaccia
            displayTracks(tracks);
            
          } catch (error) {
            console.error("Errore durante il caricamento delle tracce:", error);
            // In caso di errore, mostra un messaggio all'utente
            const songsList = document.getElementById("songsList");
            if (songsList) {
              songsList.innerHTML = `<li class="error-message">Errore nel caricamento delle tracce: ${error.message}</li>`;
            }
          }
        }

        // Funzione per gestire il login con username/password
        async function loginWithUsernamePassword() {
          const username = loginUsername.value.trim();
          const password = loginPassword.value.trim();

          if (!username || !password) {
            loginError.textContent = "Inserisci username e password.";
            loginError.style.display = "block";
            return;
          }

          try {
            // Uso l'istanza Shogun per autenticazione
            const result = await window.shogun.login(username, password);

            if (result && result.success === true) {
              loginSuccess.textContent = "Accesso effettuato con successo.";
              loginSuccess.style.display = "block";
              loginError.style.display = "none";

              // Aggiorna UI
              authContainer.style.display = "none";
              appContainer.style.display = "flex";

              // Aggiorna lo stato del server Gun
              updateGunStatus();

              // Aggiorna profilo utente
              updateUserProfile();

              // Inizializza contenuto
              initUserContent();
            } else {
              // Se l'autenticazione non è riuscita, mostra un errore
              loginError.textContent =
                result.error || "Credenziali non valide.";
              loginError.style.display = "block";
              loginSuccess.style.display = "none";
            }
          } catch (error) {
            loginError.textContent =
              "Errore durante l'accesso: " + error.message;
            loginError.style.display = "block";
            loginSuccess.style.display = "none";
          }
        }

        // Funzione per aggiornare lo stato della connessione Gun
        function updateGunStatus() {
          const gunStatus = document.getElementById("gunStatus");
          if (gunStatus) {
            if (window.shogun && window.shogun.gun) {
              gunStatus.textContent = "Connesso";
              gunStatus.className = "status-connected";
            } else {
              gunStatus.textContent = "Disconnesso";
              gunStatus.className = "status-disconnected";
            }
          }
        }

        // Funzione per gestire la registrazione con username/password
        async function signupWithUsernamePassword() {
          const username = signupUsername.value.trim();
          const password = signupPassword.value.trim();
          const passwordConfirm = signupPasswordConfirm.value.trim();

          if (!username || !password || !passwordConfirm) {
            signupError.textContent = "Compila tutti i campi.";
            signupError.style.display = "block";
            return;
          }

          if (password !== passwordConfirm) {
            signupError.textContent = "Le password non corrispondono.";
            signupError.style.display = "block";
            return;
          }

          try {
            const result = await window.shogun.signUp(username, password);

            if (result && result.success) {
              signupSuccess.textContent =
                "Registrazione effettuata con successo.";
              signupSuccess.style.display = "block";
              signupError.style.display = "none";

              // Aggiorna UI
              authContainer.style.display = "none";
              appContainer.style.display = "flex";

              // Aggiorna profilo utente
              updateUserProfile();

              // Inizializza contenuto
              initUserContent();
            } else {
              signupError.textContent =
                result.error || "Errore durante la registrazione.";
              signupError.style.display = "block";
            }
          } catch (error) {
            signupError.textContent =
              "Errore durante la registrazione: " + error.message;
            signupError.style.display = "block";
            signupSuccess.style.display = "none";
          }
        }

        // Funzione per gestire il login con WebAuthn
        async function loginWithWebAuthn() {
          try {
            // Verifica il supporto a WebAuthn
            if (!window.shogun.isWebAuthnSupported()) {
              loginError.textContent =
                "WebAuthn non è supportato dal tuo browser";
              loginError.style.display = "block";
              return;
            }

            // Ottieni il valore username dal campo di login
            const username = loginUsername.value.trim();
            if (!username) {
              loginError.textContent =
                "Inserisci un username per accedere con WebAuthn";
              loginError.style.display = "block";
              return;
            }

            // Esegui il login con WebAuthn
            const result = await window.shogun.loginWithWebAuthn(username);

            if (result.success) {
              loginSuccess.textContent =
                "Accesso con WebAuthn effettuato con successo";
              loginSuccess.style.display = "block";
              loginError.style.display = "none";

              // Aggiorna UI
              authContainer.style.display = "none";
              appContainer.style.display = "flex";

              // Aggiorna profilo utente
              updateUserProfile();

              // Inizializza contenuto
              initUserContent();
            } else {
              throw new Error(
                result.error || "Autenticazione WebAuthn fallita"
              );
            }
          } catch (error) {
            console.error("Errore WebAuthn:", error);
            loginError.textContent =
              error.message || "Errore durante l'accesso con WebAuthn";
            loginError.style.display = "block";
            loginSuccess.style.display = "none";
          }
        }

        // Funzione per gestire la registrazione con WebAuthn
        async function signupWithWebAuthn() {
          try {
            // Verifica il supporto a WebAuthn
            if (!window.shogun.isWebAuthnSupported()) {
              signupError.textContent =
                "WebAuthn non è supportato dal tuo browser";
              signupError.style.display = "block";
              return;
            }

            // Ottieni il valore username dal campo di registrazione
            const username = signupUsername.value.trim();
            if (!username) {
              signupError.textContent =
                "Inserisci un username per registrarti con WebAuthn";
              signupError.style.display = "block";
              return;
            }

            // Esegui la registrazione con WebAuthn
            const result = await window.shogun.signUpWithWebAuthn(username);

            if (result.success) {
              signupSuccess.textContent =
                "Registrazione con WebAuthn completata con successo";
              signupSuccess.style.display = "block";
              signupError.style.display = "none";

              // Aggiorna UI
              authContainer.style.display = "none";
              appContainer.style.display = "flex";

              // Aggiorna profilo utente
              updateUserProfile();

              // Inizializza contenuto
              initUserContent();
            } else {
              throw new Error(result.error || "Registrazione WebAuthn fallita");
            }
          } catch (error) {
            console.error("Errore WebAuthn:", error);
            signupError.textContent =
              error.message || "Errore durante la registrazione con WebAuthn";
            signupError.style.display = "block";
            signupSuccess.style.display = "none";
          }
        }

        // Funzione per gestire il login con MetaMask
        async function loginWithMetaMask() {
          try {
            loginError.style.display = "none";
            loginSuccess.style.display = "none";
            
            // Mostra messaggio di caricamento
            loginError.textContent = "Connessione con MetaMask in corso...";
            loginError.style.display = "block";
            loginError.style.color = "#3498db"; // Colore blu per indicare caricamento
            
            // Verifica che MetaMask sia disponibile
            if (!window.ethereum) {
              loginError.textContent =
                "MetaMask non è installato. Installa l'estensione MetaMask per continuare.";
              loginError.style.color = "#e74c3c"; // Torna al rosso per errore
              loginError.style.display = "block";
              return;
            }

            // Ottieni l'indirizzo da MetaMask
            const accounts = await window.ethereum.request({
              method: "eth_requestAccounts",
            });

            if (!accounts || accounts.length === 0) {
              throw new Error("Nessun account trovato in MetaMask");
            }

            loginError.textContent = "Account MetaMask selezionato, autenticazione in corso...";
            const address = accounts[0];

            // Login con MetaMask via Shogun
            try {
              const result = await window.shogun.loginWithMetaMask(address);

              console.log(result);

              if (result && result.success) {
                loginSuccess.textContent =
                  "Accesso con MetaMask effettuato con successo";
                loginSuccess.style.display = "block";
                loginError.style.display = "none";

                // Aggiorna UI
                authContainer.style.display = "none";
                appContainer.style.display = "flex";

                // Aggiorna profilo utente
                updateUserProfile();

                // Inizializza contenuto
                initUserContent();
              } else {
                throw new Error(
                  result.error || "Autenticazione MetaMask fallita"
                );
              }
            } catch (authError) {
              console.error("Errore durante l'autenticazione MetaMask:", authError);
              
              // Verifica se l'errore è correlato al timeout DID
              if (authError.message && authError.message.includes("Timeout")) {
                loginError.textContent = 
                  "Timeout durante la connessione. Il server potrebbe non essere raggiungibile. Riprova più tardi.";
              } else {
                loginError.textContent =
                  authError.message || "Errore durante l'accesso con MetaMask";
              }
              
              loginError.style.color = "#e74c3c"; // Rosso per errore
              loginError.style.display = "block";
              loginSuccess.style.display = "none";
            }
          } catch (error) {
            console.error("Errore MetaMask generale:", error);
            loginError.textContent =
              error.message || "Errore durante l'accesso con MetaMask";
            loginError.style.color = "#e74c3c"; // Rosso per errore
            loginError.style.display = "block";
            loginSuccess.style.display = "none";
          }
        }

        // Funzione per gestire la registrazione con MetaMask
        async function signupWithMetaMask() {
          try {
            signupError.style.display = "none";
            signupSuccess.style.display = "none";
            
            // Mostra messaggio di caricamento
            signupError.textContent = "Connessione con MetaMask in corso...";
            signupError.style.display = "block";
            signupError.style.color = "#3498db"; // Colore blu per indicare caricamento
            
            // Verifica che MetaMask sia disponibile
            if (!window.ethereum) {
              signupError.textContent =
                "MetaMask non è installato. Installa l'estensione MetaMask per continuare.";
              signupError.style.color = "#e74c3c"; // Torna al rosso per errore
              signupError.style.display = "block";
              return;
            }

            // Ottieni l'indirizzo da MetaMask
            const accounts = await window.ethereum.request({
              method: "eth_requestAccounts",
            });

            if (!accounts || accounts.length === 0) {
              throw new Error("Nessun account trovato in MetaMask");
            }

            signupError.textContent = "Account MetaMask selezionato, registrazione in corso...";
            const address = accounts[0];

            // Registrazione con MetaMask via Shogun
            try {
              const result = await window.shogun.signUpWithMetaMask(address);

              if (result && result.success) {
                signupSuccess.textContent =
                  "Registrazione con MetaMask completata con successo";
                signupSuccess.style.display = "block";
                signupError.style.display = "none";

                // Aggiorna UI
                authContainer.style.display = "none";
                appContainer.style.display = "flex";

                // Aggiorna profilo utente
                updateUserProfile();

                // Inizializza contenuto
                initUserContent();
              } else {
                if (
                  result &&
                  result.error &&
                  result.error.includes("already exists")
                ) {
                  signupError.textContent =
                    "Utente già registrato. Prova ad accedere invece.";
                  signupError.style.color = "#e74c3c"; // Rosso per errore
                  signupError.style.display = "block";
                } else {
                  throw new Error(
                    result.error || "Registrazione MetaMask fallita"
                  );
                }
              }
            } catch (authError) {
              console.error("Errore durante la registrazione MetaMask:", authError);
              
              // Verifica se l'errore è correlato al timeout DID
              if (authError.message && authError.message.includes("Timeout")) {
                signupError.textContent = 
                  "Timeout durante la connessione. Il server potrebbe non essere raggiungibile. Riprova più tardi.";
              } else {
                signupError.textContent =
                  authError.message || "Errore durante la registrazione con MetaMask";
              }
              
              signupError.style.color = "#e74c3c"; // Rosso per errore
              signupError.style.display = "block";
              signupSuccess.style.display = "none";
            }
          } catch (error) {
            console.error("Errore MetaMask generale:", error);
            signupError.textContent =
              error.message || "Errore durante la registrazione con MetaMask";
            signupError.style.color = "#e74c3c"; // Rosso per errore
            signupError.style.display = "block";
            signupSuccess.style.display = "none";
          }
        }

        // Gestione dei tab di autenticazione
        authTabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            authTabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            const tabName = tab.getAttribute("data-tab");
            if (tabName === "login") {
              loginForm.style.display = "block";
              signupForm.style.display = "none";
            } else {
              loginForm.style.display = "none";
              signupForm.style.display = "block";
            }
          });
        });

        // Gestione del logout
        const logoutBtn = document.getElementById("logoutBtn");
        logoutBtn.addEventListener("click", async () => {
          try {
            await window.shogun.logout();

            // Aggiorna UI
            authContainer.style.display = "flex";
            appContainer.style.display = "none";

            // Reset dati utente
            const userProfileUsername = document.getElementById(
              "userProfileUsername"
            );
            if (userProfileUsername) {
              userProfileUsername.textContent = "Utente";
            }
          } catch (error) {
            console.error("Errore durante il logout:", error);
            alert("Errore durante il logout: " + error.message);
          }
        });

        // Gestione dei pulsanti di autenticazione
        loginButton.addEventListener("click", loginWithUsernamePassword);
        signupButton.addEventListener("click", signupWithUsernamePassword);
        webauthnLoginBtn.addEventListener("click", loginWithWebAuthn);
        webauthnSignupBtn.addEventListener("click", signupWithWebAuthn);
        metamaskLoginBtn.addEventListener("click", loginWithMetaMask);
        metamaskSignupBtn.addEventListener("click", signupWithMetaMask);
      });

      // Funzione per visualizzare le tracce
      function displayTracks(tracks) {
        const songsList = document.getElementById("songsList");
        songsList.innerHTML = "";

        if (!tracks || tracks.length === 0) {
          document.getElementById("songsEmpty").style.display = "block";
          return;
        }

        document.getElementById("songsEmpty").style.display = "none";

        tracks.forEach((track) => {
          const li = document.createElement("li");
          li.className = "song-item";

          // Crea l'HTML per l'artwork
          let artworkHTML = "";
          if (track.artwork_path) {
            let artworkUrl = track.artwork_path;
            if (track.artwork_path.startsWith("/") && track.originUrl) {
              artworkUrl = `${track.originUrl}${track.artwork_path}`;
            } else if (track.artwork_path.startsWith("/")) {
              // Se il percorso inizia con / ma non c'è originUrl, usa il server corrente
              artworkUrl = `${window.location.origin}${track.artwork_path}`;
            }

            artworkHTML = `<img class="artwork" src="${artworkUrl}" alt="${track.title}" onerror="this.parentNode.innerHTML='<div class=\\'artwork-placeholder\\'>♪</div>';" />`;
          } else {
            artworkHTML = `<div class="artwork-placeholder">♪</div>`;
          }

          li.innerHTML = `
            ${artworkHTML}
            <div class="song-info">
              <div class="song-title">${track.title}</div>
              <div class="song-artist">${track.artist}</div>
            </div>
            <div class="song-actions">
              <button class="play-button" data-track-id="${
                track.id
              }">Play</button>
              <button class="favorite-button" data-track-id="${track.id}">${
            isFavorite(track.id) ? "★" : "☆"
          }</button>
              <button class="options-button" data-track-id="${
                track.id
              }">⋮</button>
            </div>
          `;
          songsList.appendChild(li);
        });

        // Aggiungi eventi ai pulsanti
        const playButtons = document.querySelectorAll(".play-button");
        const favoriteButtons = document.querySelectorAll(".favorite-button");
        const optionsButtons = document.querySelectorAll(".options-button");

        playButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            playSong(trackId);
          });
        });

        favoriteButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            toggleFavorite(trackId);
          });
        });

        optionsButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            showTrackOptions(trackId);
          });
        });
      }

      // Funzione per aggiungere/rimuovere un item dai preferiti
      function toggleFavorite(itemId, type = "songs") {
        if (!userFavorites) {
          userFavorites = {
            songs: [],
            artists: [],
            albums: [],
          };
        }

        // Assicurati che l'array per questo tipo esista
        if (!userFavorites[type] || !Array.isArray(userFavorites[type])) {
          userFavorites[type] = [];
        }

        // Converti in stringa per confronto uniforme
        const itemIdStr = String(itemId);
        
        // Trova l'indice dell'item (confrontando le stringhe)
        const index = userFavorites[type].findIndex(id => String(id) === itemIdStr);
        
        if (index === -1) {
          // Aggiungi ai preferiti
          userFavorites[type].push(itemIdStr);
          console.log(`Aggiunto ${itemIdStr} ai preferiti di tipo ${type}`);
        } else {
          // Rimuovi dai preferiti
          userFavorites[type].splice(index, 1);
          console.log(`Rimosso ${itemIdStr} dai preferiti di tipo ${type}`);
        }

        // Aggiorna i contatori dei preferiti
        updateFavoriteCounts();

        // Salva i preferiti in GunDB
        saveUserFavoritesToGun();

        // Aggiorna tutte le icone nella lista tracce
        const favoriteButtons = document.querySelectorAll(
          `.favorite-button[data-track-id="${itemIdStr}"]`
        );
        
        const isFav = userFavorites[type].some(id => String(id) === itemIdStr);
        
        favoriteButtons.forEach((button) => {
          button.textContent = isFav ? "★" : "☆";
        });

        // Se siamo nella vista preferiti, aggiorna la visualizzazione
        updateFavoritesDisplay();
        
        return isFav; // Restituisci lo stato attuale (utile per interfacce)
      }

      // Funzione per verificare se una traccia è nei preferiti
      function isFavorite(trackId) {
        if (!userFavorites || !userFavorites.songs || !Array.isArray(userFavorites.songs)) {
          return false;
        }
        
        // Converti in stringa per confronto uniforme
        const trackIdStr = String(trackId);
        return userFavorites.songs.some(id => String(id) === trackIdStr);
      }

      // Funzione per visualizzare i preferiti
      function displayFavorites(type = "songs") {
        console.log("Visualizzazione preferiti di tipo:", type);

        // Mostra il tab Preferiti
        const favoritesTab = document.querySelector(
          '.content-tab[data-tab="favorites"]'
        );
        if (favoritesTab) {
          console.log("Click sul tab Preferiti");
          favoritesTab.click();
        }

        // Aggiorna l'intestazione
        let sectionTitle = "";
        switch (type) {
          case "songs":
            sectionTitle = "Brani preferiti";
            break;
          case "artists":
            sectionTitle = "Artisti preferiti";
            break;
          case "albums":
            sectionTitle = "Album preferiti";
            break;
        }

        const favoriteSectionTitle = document.getElementById(
          "currentFavoriteSection"
        );
        if (favoriteSectionTitle) {
          favoriteSectionTitle.textContent = sectionTitle;
        }

        // Nascondi tutte le sezioni di preferiti
        document.getElementById("favoriteSongsSection").style.display = "none";
        document.getElementById("favoriteArtistsSection").style.display =
          "none";
        document.getElementById("favoriteAlbumsSection").style.display = "none";

        // Mostra la sezione richiesta
        const sectionId = `favorite${
          type.charAt(0).toUpperCase() + type.slice(1)
        }Section`;
        const sectionToShow = document.getElementById(sectionId);
        if (sectionToShow) {
          sectionToShow.style.display = "block";
        }

        // Mostra i preferiti specifici in base al tipo
        switch (type) {
          case "songs":
            displayFavoriteSongs();
            break;
          case "artists":
            // Implementare la visualizzazione degli artisti preferiti
            break;
          case "albums":
            // Implementare la visualizzazione degli album preferiti
            break;
        }
      }

      // Funzione per visualizzare i brani preferiti
      function displayFavoriteSongs() {
        console.log("Visualizzazione brani preferiti...");
        console.log("Brani preferiti:", userFavorites.songs);
        
        const favoriteSongsList = document.getElementById("favoriteSongsList");
        if (!favoriteSongsList) {
          console.error("Elemento favoriteSongsList non trovato nel DOM");
          return;
        }
        
        favoriteSongsList.innerHTML = "";

        if (
          !userFavorites ||
          !userFavorites.songs ||
          !Array.isArray(userFavorites.songs) ||
          userFavorites.songs.length === 0
        ) {
          console.log("Nessun brano preferito da visualizzare");
          const emptyElement = document.getElementById("favoriteSongsEmpty");
          if (emptyElement) {
            emptyElement.style.display = "block";
          }
          return;
        }

        const emptyElement = document.getElementById("favoriteSongsEmpty");
        if (emptyElement) {
          emptyElement.style.display = "none";
        }

        userFavorites.songs.forEach((trackId) => {
          console.log("Elaborazione brano preferito:", trackId);
          const track = getTrackById(trackId);
          
          if (track) {
            console.log("Creazione elemento per il brano:", track.title);
            const li = document.createElement("li");
            li.className = "song-item";
            
            // Crea l'HTML per l'artwork
            let artworkHTML = "";
            if (track.artwork_path) {
              let artworkUrl = track.artwork_path;
              if (track.artwork_path.startsWith("/") && track.originUrl) {
                artworkUrl = `${track.originUrl}${track.artwork_path}`;
              } else if (track.artwork_path.startsWith("/")) {
                artworkUrl = `${window.location.origin}${track.artwork_path}`;
              }

              artworkHTML = `<img class="artwork" src="${artworkUrl}" alt="${track.title}" onerror="this.parentNode.innerHTML='<div class=\\'artwork-placeholder\\'>♪</div>';" />`;
            } else {
              artworkHTML = `<div class="artwork-placeholder">♪</div>`;
            }
            
            li.innerHTML = `
              ${artworkHTML}
              <div class="song-info">
                <div class="song-title">${track.title}</div>
                <div class="song-artist">${track.artist}</div>
              </div>
              <div class="song-actions">
                <button class="play-button" data-track-id="${track.id}">Play</button>
                <button class="favorite-button" data-track-id="${track.id}">★</button>
                <button class="options-button" data-track-id="${track.id}">⋮</button>
              </div>
            `;
            favoriteSongsList.appendChild(li);
          } else {
            console.error("Impossibile trovare il brano con ID:", trackId);
          }
        });

        console.log("Brani preferiti visualizzati:", favoriteSongsList.children.length);

        // Aggiungi eventi ai pulsanti
        const playButtons = favoriteSongsList.querySelectorAll(".play-button");
        const favoriteButtons = favoriteSongsList.querySelectorAll(".favorite-button");
        const optionsButtons = favoriteSongsList.querySelectorAll(".options-button");

        playButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            playSong(trackId);
          });
        });

        favoriteButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            toggleFavorite(trackId);
          });
        });

        optionsButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            showTrackOptions(trackId);
          });
        });
      }

      // Funzione per ottenere una traccia dal suo ID
      function getTrackById(trackId) {
        console.log("Cercando traccia con ID:", trackId);
        
        if (!trackId) {
          console.warn("ID traccia non valido");
          return null;
        }
        
        // Converti in stringa per i confronti
        const trackIdStr = String(trackId);
        
        console.log("Numero di tracce disponibili:", tracks?.length || 0);
        
        // Prima cerchiamo nelle tracce locali
        if (Array.isArray(tracks) && tracks.length > 0) {
          const track = tracks.find((t) => String(t.id) === trackIdStr);
          if (track) {
            console.log("Traccia trovata in 'tracks':", track.title);
            return track;
          }
        } else {
          console.warn("Array 'tracks' non disponibile o vuoto");
        }

        // Poi cerchiamo in allTracks se esiste
        if (Array.isArray(allTracks) && allTracks.length > 0) {
          const track = allTracks.find((t) => String(t.id) === trackIdStr);
          if (track) {
            console.log("Traccia trovata in 'allTracks':", track.title);
            return track;
          }
        } else {
          console.warn("Array 'allTracks' non disponibile o vuoto");
        }

        // Se ancora non trovata, ma le tracce di esempio sono disponibili, utilizziamo quelle
        const exampleTrack = {
          id: trackIdStr,
          title: "Brano mancante",
          artist: "Artista sconosciuto",
          album: "Album sconosciuto",
          duration: 0,
          artwork_path: null
        };
        
        console.warn(`Traccia con ID ${trackIdStr} non trovata, uso placeholder`);
        return exampleTrack;
      }

      // Funzione per mostrare le opzioni di una traccia
      function showTrackOptions(trackId) {
        console.log("Mostrando opzioni per la traccia:", trackId);
        
        // Verifico se esiste già un menu dropdown
        let dropdown = document.querySelector(".track-options-dropdown");
        if (dropdown) {
          dropdown.remove();
        }

        // Trova il pulsante delle opzioni cliccato
        const optionsButton = document.querySelector(
          `.options-button[data-track-id="${trackId}"]`
        );
        if (!optionsButton) {
          console.error("Pulsante opzioni non trovato per la traccia", trackId);
          return;
        }

        // Crea il menu dropdown
        dropdown = document.createElement("div");
        dropdown.className = "track-options-dropdown";
        dropdown.style.position = "absolute";
        dropdown.style.backgroundColor = "#333";
        dropdown.style.borderRadius = "4px";
        dropdown.style.boxShadow = "0 2px 10px rgba(0,0,0,0.3)";
        dropdown.style.zIndex = "100";
        dropdown.style.minWidth = "200px";

        // Posiziona il dropdown vicino al pulsante
        const rect = optionsButton.getBoundingClientRect();
        dropdown.style.top = `${rect.bottom + window.scrollY}px`;
        dropdown.style.left = `${rect.left + window.scrollX - 150}px`; // Allineato a destra del pulsante

        // Aggiungi opzioni al dropdown
        dropdown.innerHTML = `
          <div style="padding: 10px; border-bottom: 1px solid #444;">
            <div style="color: #CCC; font-size: 14px;">Aggiungi a playlist</div>
          </div>
        `;

        // Crea lista delle playlist
        const playlistsList = document.createElement("div");
        playlistsList.style.maxHeight = "200px";
        playlistsList.style.overflowY = "auto";

        if (!userPlaylists || userPlaylists.length === 0) {
          playlistsList.innerHTML = `
            <div style="padding: 10px; color: #999; font-style: italic;">
              Nessuna playlist disponibile
            </div>
          `;
        } else {
          console.log("Playlist disponibili:", userPlaylists.length);
          
          // Prima di mostrare le playlist, controlliamo che siano valide
          const validPlaylists = userPlaylists.filter(p => p && p.id && p.name);
          console.log("Playlist valide:", validPlaylists.length);
          
          validPlaylists.forEach((playlist) => {
            console.log("Creando elemento per playlist:", playlist.name);
            const playlistItem = document.createElement("div");
            playlistItem.style.padding = "8px 16px";
            playlistItem.style.cursor = "pointer";
            playlistItem.style.transition = "background-color 0.2s";
            playlistItem.textContent = playlist.name;

            // Evidenzia se il mouse passa sopra
            playlistItem.addEventListener("mouseover", () => {
              playlistItem.style.backgroundColor = "#444";
            });
            playlistItem.addEventListener("mouseout", () => {
              playlistItem.style.backgroundColor = "transparent";
            });

            // Evento click per aggiungere alla playlist
            playlistItem.addEventListener("click", () => {
              console.log(`Click su playlist '${playlist.name}' per aggiungere traccia ${trackId}`);
              const result = addToPlaylist(trackId, playlist.id);
              console.log("Risultato addToPlaylist:", result);
              dropdown.remove();
            });

            playlistsList.appendChild(playlistItem);
          });
        }

        dropdown.appendChild(playlistsList);

        // Aggiungi opzione per creare nuova playlist
        const createPlaylistOption = document.createElement("div");
        createPlaylistOption.style.padding = "10px";
        createPlaylistOption.style.borderTop = "1px solid #444";

        const createPlaylistForm = document.createElement("div");
        createPlaylistForm.style.display = "flex";
        createPlaylistForm.style.gap = "5px";

        const playlistNameInput = document.createElement("input");
        playlistNameInput.type = "text";
        playlistNameInput.placeholder = "Nuova playlist...";
        playlistNameInput.style.flex = "1";
        playlistNameInput.style.padding = "5px";
        playlistNameInput.style.backgroundColor = "#444";
        playlistNameInput.style.border = "none";
        playlistNameInput.style.borderRadius = "3px";
        playlistNameInput.style.color = "#FFF";

        const createBtn = document.createElement("button");
        createBtn.textContent = "Crea";
        createBtn.style.padding = "5px 10px";
        createBtn.style.backgroundColor = "#1DB954";
        createBtn.style.color = "#000";
        createBtn.style.border = "none";
        createBtn.style.borderRadius = "3px";
        createBtn.style.cursor = "pointer";

        createBtn.addEventListener("click", () => {
          const playlistName = playlistNameInput.value.trim();
          if (playlistName) {
            console.log("Creazione nuova playlist:", playlistName);
            const newPlaylist = createPlaylist(playlistName);
            if (newPlaylist) {
              console.log("Playlist creata, ora aggiungo la traccia:", trackId);
              setTimeout(() => {
                // Piccolo ritardo per garantire che la playlist sia completamente salvata
                addToPlaylist(trackId, newPlaylist.id);
              }, 100);
              dropdown.remove();
            }
          }
        });

        // Anche premendo Enter si crea la playlist
        playlistNameInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            const playlistName = playlistNameInput.value.trim();
            if (playlistName) {
              console.log("Creazione nuova playlist (via Enter):", playlistName);
              const newPlaylist = createPlaylist(playlistName);
              if (newPlaylist) {
                console.log("Playlist creata, ora aggiungo la traccia:", trackId);
                setTimeout(() => {
                  // Piccolo ritardo per garantire che la playlist sia completamente salvata
                  addToPlaylist(trackId, newPlaylist.id);
                }, 100);
                dropdown.remove();
              }
            }
          }
        });

        createPlaylistForm.appendChild(playlistNameInput);
        createPlaylistForm.appendChild(createBtn);
        createPlaylistOption.appendChild(createPlaylistForm);
        dropdown.appendChild(createPlaylistOption);

        // Aggiungi il dropdown al documento
        document.body.appendChild(dropdown);

        // Chiudi il dropdown quando si clicca altrove
        setTimeout(() => {
          const closeDropdown = (e) => {
            if (!dropdown.contains(e.target) && e.target !== optionsButton) {
              dropdown.remove();
              document.removeEventListener("click", closeDropdown);
            }
          };
          document.addEventListener("click", closeDropdown);
        }, 0);
      }

      // Funzione per aggiungere una traccia a una playlist
      function addToPlaylist(trackId, playlistId) {
        console.log(`Aggiunta traccia ${trackId} alla playlist ${playlistId}`);
        
        // Converti l'ID traccia in stringa per confronti uniformi
        const trackIdStr = String(trackId);
        
        // Cerca la playlist nell'array
        const playlist = userPlaylists.find((p) => p.id === playlistId);
        if (!playlist) {
          console.error("Playlist non trovata:", playlistId);
          alert("Errore: Playlist non trovata");
          return false;
        }

        console.log("Playlist trovata:", playlist);

        // Inizializza l'array tracks se non esiste
        if (!playlist.tracks || !Array.isArray(playlist.tracks)) {
          playlist.tracks = [];
          console.log("Inizializzato array tracks vuoto per la playlist");
        }

        // Controlla se la traccia è già presente (confrontando stringhe)
        const trackExists = playlist.tracks.some(id => String(id) === trackIdStr);
        if (trackExists) {
          console.log(`Traccia ${trackIdStr} già presente nella playlist "${playlist.name}"`);
          alert(`Il brano è già presente nella playlist "${playlist.name}"`);
          return false;
        }

        try {
          // Aggiungi la traccia alla playlist
          playlist.tracks.push(trackIdStr);
          console.log(`Traccia ${trackIdStr} aggiunta alla playlist "${playlist.name}"`);
          console.log("Tracce nella playlist dopo l'aggiunta:", playlist.tracks);

          // Aggiorna la variabile userPlaylists direttamente
          const playlistIndex = userPlaylists.findIndex(p => p.id === playlistId);
          if (playlistIndex !== -1) {
            userPlaylists[playlistIndex] = playlist;
          }

          // Salva le modifiche immediatamente
          saveUserPlaylistsToGun();

          // Mostra un messaggio di conferma
          alert(`Brano aggiunto alla playlist "${playlist.name}"`);

          // Aggiorna la visualizzazione se necessario
          if (currentPlaylistId === playlistId) {
            displayPlaylistTracks(playlistId);
          }

          // Aggiorna il contatore nella sidebar
          displayPlaylists();

          return true;
        } catch (error) {
          console.error("Errore nell'aggiunta della traccia alla playlist:", error);
          console.error("Dettagli playlist:", JSON.stringify(playlist));
          console.error("Stack trace:", error.stack);
          alert("Si è verificato un errore nell'aggiunta del brano alla playlist");
          return false;
        }
      }

      // Funzione per riprodurre una traccia
      function playSong(trackData) {
        console.log("Riproduzione traccia:", trackData);

        // Controllo che wavesurfer sia stato inizializzato
        if (typeof WaveSurfer === "undefined") {
          console.error("WaveSurfer non è disponibile");
          alert("Impossibile riprodurre: il player audio non è disponibile");
          return;
        }

        // Se abbiamo un oggetto track, usiamo quello, altrimenti cerchiamo per ID
        let track = trackData;
        if (typeof trackData === "string") {
          track = getTrackById(trackData);
          if (!track) {
            console.error("Traccia non trovata:", trackData);
            return;
          }
        }

        // Aggiorna UI player
        const nowPlaying = document.getElementById("nowPlaying");
        const nowPlayingTitle = document.getElementById("nowPlayingTitle");
        const nowPlayingArtist = document.getElementById("nowPlayingArtist");
        const nowPlayingArtwork = document.getElementById("nowPlayingArtwork");

        if (nowPlaying) nowPlaying.style.display = "flex";
        if (nowPlayingTitle)
          nowPlayingTitle.textContent = track.title || "Senza titolo";
        if (nowPlayingArtist)
          nowPlayingArtist.textContent = track.artist || "Artista sconosciuto";

        if (nowPlayingArtwork) {
          if (track.artwork_path) {
            nowPlayingArtwork.innerHTML = "";
            const img = document.createElement("img");

            // Usa l'originUrl se disponibile, altrimenti fallback
            let artworkPath = track.artwork_path;
            if (track.artwork_path.startsWith("/") && track.originUrl) {
              artworkPath = `${track.originUrl}${track.artwork_path}`;
            } else if (track.artwork_path.startsWith("/")) {
              // Se il percorso inizia con / ma non c'è originUrl, usa il server corrente
              artworkPath = `${window.location.origin}${track.artwork_path}`;
            }

            console.log("Caricamento artwork da:", artworkPath);
            img.src = artworkPath;
            img.className = "artwork";
            img.alt = "Artwork";
            img.onerror = function () {
              console.error("Errore nel caricamento dell'artwork");
              nowPlayingArtwork.innerHTML = "♪";
              nowPlayingArtwork.className = "artwork-placeholder";
            };
            nowPlayingArtwork.className = "";
            nowPlayingArtwork.appendChild(img);
          } else {
            nowPlayingArtwork.innerHTML = "♪";
            nowPlayingArtwork.className = "artwork-placeholder";
          }
        }

        // Ottieni il percorso audio
        let audioPath = track.audio_path;

        // Se il percorso non inizia con http/https, costruisci l'URL assoluto
        if (audioPath && !audioPath.startsWith("http")) {
          const baseUrl = track.originUrl || window.location.origin;
          audioPath = `${baseUrl}${audioPath}`;
        }

        console.log(`Caricamento audio da: ${audioPath}`);

        // Controllo di sicurezza: non caricare se il percorso è null o vuoto
        if (!audioPath) {
          console.error(
            "Tentativo di caricare una traccia senza percorso audio valido:",
            track
          );
          alert(
            `Errore: Impossibile trovare il file audio per la traccia "${track.title}".`
          );
          return;
        }

        // Inizializza wavesurfer se non esiste
        if (!window.wavesurfer) {
          window.wavesurfer = WaveSurfer.create({
            container: "#waveform",
            waveColor: "#4caf50",
            progressColor: "#2196f3",
            cursorColor: "#333",
            barWidth: 2,
            barRadius: 3,
            cursorWidth: 1,
            height: 80,
            barGap: 3,
            responsive: true,
          });

          // Inizializza gli eventi di wavesurfer
          window.wavesurfer.on("ready", function () {
            console.log("WaveSurfer pronto");
            const playBtn = document.getElementById("playBtn");
            const pauseBtn = document.getElementById("pauseBtn");
            if (playBtn) playBtn.disabled = false;
            if (pauseBtn) pauseBtn.disabled = false;

            // Avvia la riproduzione automaticamente
            window.wavesurfer.play();

            // Aggiorna l'interfaccia
            if (playBtn) playBtn.style.display = "none";
            if (pauseBtn) pauseBtn.style.display = "inline-block";
          });

          window.wavesurfer.on("finish", function () {
            console.log("Riproduzione completata");
            const playBtn = document.getElementById("playBtn");
            const pauseBtn = document.getElementById("pauseBtn");
            if (playBtn) playBtn.style.display = "inline-block";
            if (pauseBtn) pauseBtn.style.display = "none";
          });

          window.wavesurfer.on("error", function (err) {
            console.error("Errore WaveSurfer:", err);
            alert("Errore durante il caricamento dell'audio");
          });
        }

        // Carica e riproduce l'audio
        window.wavesurfer.load(audioPath);
      }

      // Funzione per gestire i tab del contenuto
      function setupContentTabs() {
        console.log("Inizializzazione tab di contenuto...");
        const contentTabs = document.querySelectorAll(".content-tab");
        const tabContents = document.querySelectorAll(".tab-content");

        console.log("Tab trovati:", contentTabs.length);
        console.log("Contenuti tab trovati:", tabContents.length);

        contentTabs.forEach((tab) => {
          const tabName = tab.getAttribute("data-tab");
          console.log("Aggiungo listener al tab:", tabName);

          tab.addEventListener("click", () => {
            const tabName = tab.getAttribute("data-tab");
            console.log("Tab cliccato:", tabName);

            // Rimuovi active da tutti i tab
            contentTabs.forEach((t) => {
              t.classList.remove("active");
            });

            // Aggiungi active al tab cliccato
            tab.classList.add("active");

            // Nascondi tutti i contenuti
            tabContents.forEach((content) => {
              content.classList.remove("active");
              console.log("Nascosto contenuto:", content.id);
            });

            // Mostra il contenuto corrispondente
            const targetContent = document.getElementById(`${tabName}-tab`);
            if (targetContent) {
              targetContent.classList.add("active");
              console.log("Mostrato contenuto:", targetContent.id);

              // Se è il tab preferiti, mostra la sezione brani di default
              if (tabName === "favorites") {
                displayFavorites("songs");
              } else if (
                tabName === "playlists" &&
                userPlaylists &&
                userPlaylists.length > 0
              ) {
                // Se è il tab playlist e ci sono playlist, mostra la prima
                displayPlaylistTracks(userPlaylists[0].id);
              }
            } else {
              console.error("Contenuto non trovato per il tab:", tabName);
            }
          });
        });
      }

      // Inizializza i tab del contenuto
      setupContentTabs();

      // Funzione per visualizzare le playlist
      function displayPlaylists() {
        console.log("Visualizzazione playlist dell'utente");
        const playlistsMenu = document.getElementById("playlistsMenu");
        
        if (!playlistsMenu) {
          console.error("Elemento playlistsMenu non trovato nel DOM");
          return;
        }
        
        playlistsMenu.innerHTML = "";

        if (!userPlaylists || userPlaylists.length === 0) {
          console.log("Nessuna playlist disponibile");
          playlistsMenu.innerHTML =
            '<div class="playlist-item">Nessuna playlist disponibile</div>';
          return;
        }

        console.log(`Visualizzazione di ${userPlaylists.length} playlist:`, userPlaylists);

        userPlaylists.forEach((playlist) => {
          if (!playlist || !playlist.name) {
            console.warn("Playlist non valida o senza nome:", playlist);
            return; // Salta questa playlist
          }
          
          const playlistItem = document.createElement("div");
          playlistItem.className = "playlist-item";
          
          // Evidenzia la playlist attiva
          if (currentPlaylistId === playlist.id) {
            playlistItem.classList.add("active");
          }

          const trackCount = playlist.tracks && Array.isArray(playlist.tracks) ? playlist.tracks.length : 0;

          playlistItem.innerHTML = `
            <div class="playlist-name">
              ${playlist.name}
              <span class="count-badge">${trackCount}</span>
            </div>
            <div class="playlist-actions">
              <button class="playlist-small-button delete-playlist" title="Elimina playlist">×</button>
            </div>
          `;

          // Click sulla playlist
          playlistItem.querySelector(".playlist-name").addEventListener("click", () => {
            console.log(`Click su playlist: ${playlist.name} (ID: ${playlist.id})`);
            displayPlaylistTracks(playlist.id);
          });

          // Click per eliminare la playlist
          playlistItem
            .querySelector(".delete-playlist")
            .addEventListener("click", (e) => {
              e.stopPropagation();
              if (
                confirm(
                  `Vuoi davvero eliminare la playlist "${playlist.name}"?`
                )
              ) {
                deletePlaylist(playlist.id);
              }
            });

          playlistsMenu.appendChild(playlistItem);
        });
      }

      // Funzione per visualizzare i brani di una playlist
      function displayPlaylistTracks(playlistId) {
        console.log("Visualizzazione tracce della playlist:", playlistId);

        // Variabile per tenere traccia della playlist corrente
        currentPlaylistId = playlistId;

        // Aggiorna il tab playlists
        document.querySelector('.content-tab[data-tab="playlists"]').click();

        const playlist = userPlaylists.find((p) => p.id === playlistId);
        if (!playlist) {
          console.error("Playlist non trovata:", playlistId);
          return;
        }

        // Aggiorna interfaccia
        document.getElementById("currentPlaylistName").textContent = playlist.name;
        document.getElementById("playlistInfo").style.display = "block";
        document.getElementById("playlistEmpty").style.display = "none";

        // Assicurati che l'array delle tracce esista
        if (!playlist.tracks || !Array.isArray(playlist.tracks)) {
          playlist.tracks = [];
          console.log("Inizializzato array tracce vuoto per la playlist");
        }

        // Aggiorna conteggio tracce
        const trackCount = playlist.tracks.length;
        document.getElementById("playlistTrackCount").textContent = `${trackCount} brani`;
        
        console.log(`Playlist contiene ${trackCount} tracce:`, playlist.tracks);

        // Calcola durata totale (se disponibile l'informazione)
        let totalDuration = 0;
        if (playlist.tracks && playlist.tracks.length > 0) {
          playlist.tracks.forEach((trackId) => {
            const track = getTrackById(trackId);
            if (track && track.duration) {
              totalDuration += track.duration;
            }
          });
        }

        let durationText = "";
        if (totalDuration > 0) {
          const minutes = Math.floor(totalDuration / 60);
          durationText = `${minutes} min`;
        } else {
          durationText = "Durata sconosciuta";
        }
        document.getElementById("playlistDuration").textContent = durationText;

        // Mostra le tracce
        const playlistSongsList = document.getElementById("playlistSongsList");
        playlistSongsList.innerHTML = "";

        if (!playlist.tracks || playlist.tracks.length === 0) {
          document.getElementById("playlistEmpty").style.display = "block";
          document.getElementById("playlistEmpty").textContent = "Questa playlist è vuota";
          return;
        }

        // Recupera le tracce complete in base agli ID
        const playlistTracks = [];
        
        // Converti tutti gli ID in stringhe per uniformità
        const trackIds = playlist.tracks.map(id => String(id));
        console.log("Track IDs nella playlist:", trackIds);
        
        trackIds.forEach((trackId) => {
          console.log("Cercando traccia con ID:", trackId);
          const track = getTrackById(trackId);
          if (track) {
            console.log("Traccia trovata:", track.title);
            playlistTracks.push(track);
          } else {
            console.warn(`Traccia con ID ${trackId} non trovata`);
          }
        });

        // Se non ci sono tracce valide, mostra un messaggio
        if (playlistTracks.length === 0) {
          document.getElementById("playlistEmpty").style.display = "block";
          document.getElementById("playlistEmpty").textContent = "Nessuna traccia disponibile in questa playlist";
          return;
        }

        console.log(`Visualizzando ${playlistTracks.length} tracce nella playlist`);

        // Visualizza le tracce
        playlistTracks.forEach((track) => {
          const li = document.createElement("li");
          li.className = "song-item";
          li.setAttribute("data-id", track.id);

          let artworkHTML = "";
          if (track.artwork_path) {
            let artworkUrl = track.artwork_path;
            if (track.artwork_path.startsWith("/") && track.originUrl) {
              artworkUrl = track.originUrl + track.artwork_path;
            } else if (track.artwork_path.startsWith("/")) {
              artworkUrl = `${window.location.origin}${track.artwork_path}`;
            }
            artworkHTML = `<img class="artwork" src="${artworkUrl}" alt="${track.title}" onerror="this.innerHTML='<div class=\\'artwork-placeholder\\'>♪</div>';" />`;
          } else {
            artworkHTML = `<div class="artwork-placeholder">♪</div>`;
          }

          li.innerHTML = `
            ${artworkHTML}
            <div class="song-info">
              <div class="song-title">${track.title}</div>
              <div class="song-artist">${track.artist}</div>
            </div>
            <div class="song-actions">
              <button class="play-button" data-track-id="${track.id}">Play</button>
              <button class="remove-track-button" data-track-id="${track.id}" data-playlist-id="${playlistId}">Rimuovi</button>
              <button class="favorite-button" data-track-id="${track.id}">${isFavorite(track.id) ? "★" : "☆"}</button>
            </div>
          `;

          playlistSongsList.appendChild(li);
        });

        // Aggiungi eventi ai pulsanti
        playlistSongsList.querySelectorAll(".play-button").forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            playSong(trackId);
          });
        });

        playlistSongsList.querySelectorAll(".remove-track-button").forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            const playlistId = button.getAttribute("data-playlist-id");
            if (confirm("Vuoi rimuovere questo brano dalla playlist?")) {
              removeTrackFromPlaylist(trackId, playlistId);
            }
          });
        });

        playlistSongsList.querySelectorAll(".favorite-button").forEach((button) => {
          button.addEventListener("click", () => {
            const trackId = button.getAttribute("data-track-id");
            toggleFavorite(trackId);
          });
        });
      }

      // Funzione per eliminare una playlist
      function deletePlaylist(playlistId) {
        console.log("Eliminazione playlist:", playlistId);
        
        // Trova l'indice della playlist da eliminare
        const playlistIndex = userPlaylists.findIndex(p => p.id === playlistId);
        if (playlistIndex === -1) {
          console.error("Playlist non trovata:", playlistId);
          return false;
        }
        
        // Rimuovi la playlist dall'array
        userPlaylists.splice(playlistIndex, 1);
        
        // Salva le modifiche
        saveUserPlaylistsToGun();
        
        // Resetta la playlist corrente se necessario
        if (currentPlaylistId === playlistId) {
          currentPlaylistId = null;
          
          // Nascondi le informazioni della playlist
          document.getElementById("playlistInfo").style.display = "none";
          document.getElementById("playlistEmpty").style.display = "block";
          document.getElementById("playlistEmpty").textContent = "Seleziona una playlist";
          document.getElementById("playlistSongsList").innerHTML = "";
        }
        
        // Aggiorna l'interfaccia
        displayPlaylists();
        
        console.log("Playlist eliminata con successo");
        return true;
      }

      // Funzione per rimuovere una traccia da una playlist
      function removeTrackFromPlaylist(trackId, playlistId) {
        console.log(`Rimozione traccia ${trackId} dalla playlist ${playlistId}`);
        
        const trackIdStr = String(trackId);
        
        const playlist = userPlaylists.find(p => p.id === playlistId);
        if (!playlist) {
          console.error("Playlist non trovata:", playlistId);
          return false;
        }
        
        if (!playlist.tracks || !Array.isArray(playlist.tracks)) {
          console.error("La playlist non ha un array di tracce valido");
          return false;
        }
        
        // Trova l'indice della traccia
        const trackIndex = playlist.tracks.findIndex(id => String(id) === trackIdStr);
        if (trackIndex === -1) {
          console.error(`Traccia ${trackIdStr} non trovata nella playlist ${playlist.name}`);
          return false;
        }
        
        // Rimuovi la traccia
        playlist.tracks.splice(trackIndex, 1);
        console.log(`Traccia ${trackIdStr} rimossa dalla playlist ${playlist.name}`);
        console.log("Tracce rimanenti:", playlist.tracks.length);
        
        // Salva le modifiche
        saveUserPlaylistsToGun();
        
        // Aggiorna la visualizzazione
        displayPlaylistTracks(playlistId);
        
        // Aggiorna anche la sidebar
        displayPlaylists();
        
        console.log("Traccia rimossa con successo dalla playlist");
        return true;
      }

      // Funzione per creare una nuova playlist
      function createPlaylist(playlistName) {
        if (!playlistName) {
          console.error("Nome playlist non valido");
          return null;
        }
        
        console.log("Creazione nuova playlist:", playlistName);
        
        // Genera un ID univoco per la playlist
        const playlistId = "playlist_" + Date.now().toString();
        
        // Crea la nuova playlist
        const newPlaylist = {
          id: playlistId,
          name: playlistName,
          created: Date.now(),
          tracks: []
        };
        
        // Aggiungi la playlist all'array
        if (!Array.isArray(userPlaylists)) {
          userPlaylists = [];
        }
        
        userPlaylists.push(newPlaylist);
        console.log("Playlist creata:", newPlaylist);
        
        // Salva le playlist immediatamente
        saveUserPlaylistsToGun();
        
        // Aggiorna l'interfaccia
        displayPlaylists();
        
        // Visualizza la nuova playlist
        displayPlaylistTracks(playlistId);
        
        // Restituisci l'oggetto playlist completo
        return newPlaylist;
      }

      // Funzione per salvare le playlist dell'utente
      function saveUserPlaylists() {
        // Salva le playlist in GunDB
        saveUserPlaylistsToGun();
      }

      // Funzione per aggiungere un relay
      function addRelay() {
        console.log("Aggiunta relay...");
        const relayInput = document.getElementById("relayInput");
        const relayList = document.getElementById("relayList");

        if (!relayInput || !relayList) {
          console.error("Elementi DOM per relay non trovati");
          return;
        }

        const relayUrl = relayInput.value.trim();
        if (!relayUrl) {
          alert("Inserisci un URL valido");
          return;
        }

        if (
          !relayUrl.startsWith("http://") &&
          !relayUrl.startsWith("https://")
        ) {
          alert("URL non valido. Deve iniziare con http:// o https://");
          return;
        }

        // Crea un oggetto per rappresentare il relay
        const relay = {
          url: relayUrl,
          status: "connecting",
        };

        // Aggiungi il relay alla lista
        if (!window.relays) {
          window.relays = [];
        }

        // Controlla che non sia già presente
        if (window.relays.some((r) => r.url === relayUrl)) {
          alert("Questo relay è già stato aggiunto");
          return;
        }

        // Aggiungi il relay
        window.relays.push(relay);

        // Salva nel localStorage
        localStorage.setItem(
          "shogunMusicRelays",
          JSON.stringify(window.relays)
        );

        // Aggiorna la visualizzazione
        displayRelays();

        // Pulisci l'input
        relayInput.value = "";

        console.log("Relay aggiunto:", relay);
      }

      // Funzione per mostrare i relay
      function displayRelays() {
        console.log("Visualizzazione relay...");
        const relayList = document.getElementById("relayList");

        if (!relayList) {
          console.error("Elemento DOM relayList non trovato");
          return;
        }

        relayList.innerHTML = "";

        if (!window.relays || window.relays.length === 0) {
          relayList.innerHTML =
            '<li class="relay-item">Nessun relay aggiunto</li>';
          return;
        }

        window.relays.forEach((relay) => {
          const li = document.createElement("li");
          li.className = "relay-item";

          const relayText = document.createElement("span");
          relayText.textContent = relay.url;

          const statusBadge = document.createElement("span");
          statusBadge.className = `status-badge ${relay.status}`;
          statusBadge.textContent = relay.status;

          const removeButton = document.createElement("button");
          removeButton.textContent = "Rimuovi";
          removeButton.className = "delete-btn";
          removeButton.addEventListener("click", () => removeRelay(relay.url));

          li.appendChild(relayText);
          li.appendChild(statusBadge);
          li.appendChild(removeButton);
          relayList.appendChild(li);
        });
      }

      // Funzione per rimuovere un relay
      function removeRelay(relayUrl) {
        if (!window.relays) return;

        window.relays = window.relays.filter((r) => r.url !== relayUrl);
        localStorage.setItem(
          "shogunMusicRelays",
          JSON.stringify(window.relays)
        );
        displayRelays();
      }

      // Controlla gli elementi di UI per la riproduzione
      function setupPlayerControls() {
        const playBtn = document.getElementById("playBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const volumeSlider = document.getElementById("volumeSlider");

        if (playBtn) {
          playBtn.addEventListener("click", function () {
            if (window.wavesurfer && window.wavesurfer.isReady) {
              window.wavesurfer.play();
              playBtn.style.display = "none";
              if (pauseBtn) pauseBtn.style.display = "inline-block";
            }
          });
        }

        if (pauseBtn) {
          pauseBtn.addEventListener("click", function () {
            if (window.wavesurfer && window.wavesurfer.isReady) {
              window.wavesurfer.pause();
              pauseBtn.style.display = "none";
              if (playBtn) playBtn.style.display = "inline-block";
            }
          });
        }

        if (volumeSlider) {
          volumeSlider.addEventListener("input", function () {
            if (window.wavesurfer) {
              window.wavesurfer.setVolume(volumeSlider.value);
            }
          });
        }
      }

      // Carica i relay salvati all'avvio
      function loadSavedRelays() {
        const savedRelays = localStorage.getItem("shogunMusicRelays");
        if (savedRelays) {
          try {
            window.relays = JSON.parse(savedRelays);
            displayRelays();
          } catch (e) {
            console.error("Errore nel parsing dei relay:", e);
            window.relays = [];
          }
        } else {
          window.relays = [];
        }
      }

      // Aggiungi listener al pulsante per aggiungere relay
      document.addEventListener("DOMContentLoaded", function () {
        const addRelayBtn = document.getElementById("addRelayBtn");
        if (addRelayBtn) {
          addRelayBtn.addEventListener("click", addRelay);
          console.log("Listener aggiunto al pulsante addRelayBtn");
        } else {
          console.error("Elemento addRelayBtn non trovato");
        }

        // Carica i relay salvati
        loadSavedRelays();

        // Inizializza i controlli del player
        setupPlayerControls();
      });
    </script>
  </body>
</html>
