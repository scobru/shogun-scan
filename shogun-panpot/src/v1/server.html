<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Pan Pot - Server</title>
    <script src="bugout.min.js"></script>
    <script src="translations.js"></script>
    <script src="//cdn.jsdelivr.net/npm/qrcode@latest/build/qrcode.min.js"></script>
    <style>
      :root {
        --primary-color: #6366f1;
        --primary-dark: #4f46e5;
        --secondary-color: #c084fc;
        --light-bg: #f3f4f6;
        --dark-bg: #1f2937;
        --dark-card: #111827;
        --darker-bg: #0f172a;
        --text-light: #f9fafb;
        --text-dark: #374151;
        --success: #10b981;
        --danger: #ef4444;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--darker-bg);
        color: var(--text-light);
        max-width: 800px;
        text-align: center;
        margin: 0 auto;
        width: 100%;
        padding: 20px;
        line-height: 1.6;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
      }

      .logo img {
        height: 80px;
        margin-right: 15px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      }

      h1 {
        font-size: 2.2rem;
        margin: 0;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      }

      h2 {
        font-size: 1.1rem;
        font-weight: 400;
        color: var(--secondary-color);
        margin-bottom: 20px;
      }

      .server-info {
        background-color: var(--dark-card);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        border-left: 4px solid var(--primary-color);
      }

      pre {
        background-color: var(--dark-bg);
        color: var(--text-light);
        padding: 15px;
        border-radius: 10px;
        text-align: left;
        overflow-y: auto;
        max-height: 500px;
        word-wrap: break-word;
        white-space: pre-wrap;
        line-height: 1.5;
        font-family: "Consolas", monospace;
        font-size: 0.9em;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        border-left: 4px solid var(--secondary-color);
      }

      .tech-badge {
        display: inline-block;
        background-color: rgba(99, 102, 241, 0.2);
        color: var(--primary-color);
        padding: 3px 8px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-right: 5px;
        margin-bottom: 10px;
      }

      .server-status {
        display: inline-block;
        background-color: rgba(16, 185, 129, 0.2);
        color: var(--success);
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9rem;
        margin: 10px 0;
        font-weight: 600;
      }

      footer {
        margin-top: 20px;
        font-size: 0.9em;
        color: #9ca3af;
      }

      .qr-container {
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        display: inline-block;
        margin: 15px 0;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* Language Selector */
      .lang-selector {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 10px;
      }

      .lang-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.3);
        color: var(--light-text);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .lang-btn:hover {
        background: rgba(99, 102, 241, 0.2);
        border-color: var(--primary-color);
      }

      .lang-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
      }
    </style>
  </head>
  <body>
    <div class="lang-selector">
      <button class="lang-btn active" data-lang="it">IT</button>
      <button class="lang-btn" data-lang="en">EN</button>
    </div>

    <header>
      <div class="logo">
        <img src="./shogun.svg" alt="SHOGUN Logo" />
        <div>
          <h1 data-translate="title">PAN POT</h1>
          <h2 data-translate="serverSubtitle">WebTorrent Server</h2>
        </div>
      </div>
    </header>

    <div class="tech-badge" data-translate="badges.bugout">Bugout</div>
    <div class="tech-badge" data-translate="badges.webTorrent">WebTorrent</div>
    <div class="tech-badge" data-translate="badges.server">Server</div>

    <div class="server-info">
      <div class="server-status" data-translate="status.readyServer">Server Attivo</div>
      <div id="address-display"></div>
      <div id="qr-container" class="qr-container" style="display: none;"></div>
    </div>

    <pre id="log" data-translate="system.initializingServer">Inizializzazione del server...</pre>

    <footer>
      <p data-translate="footer.server">Pan Pot - Messageboard Server</p>
    </footer>
  </body>
  <script>
    // Language management
    function setLanguage(lang) {
      // Aggiorna i pulsanti
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // Aggiorna i testi
      document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.dataset.translate;
        const value = key.split('.').reduce((obj, i) => obj[i], translations[lang]);
        if (value) {
          element.textContent = value;
        }
      });

      // Salva la preferenza
      localStorage.setItem('preferred-language', lang);
    }

    // Gestione click sui pulsanti lingua
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
    });

    // Imposta la lingua iniziale
    const savedLang = localStorage.getItem('preferred-language') || 'it';
    setLanguage(savedLang);

    log("*BUGOUT*");
    log("\nmessageboard server\n");
    log("(view source to see the server code)\n");

    // instantiate our bugout instance
    var b = new Bugout({ seed: localStorage["bugout-messageboard-seed"] });
    // save the seed for next time
    localStorage["bugout-messageboard-seed"] = b.seed;

    // log this server's address
    log("address:", b.address());
    const currentLang = localStorage.getItem('preferred-language') || 'it';
    document.getElementById("address-display").innerHTML = `<strong>${translations[currentLang].status.serverAddress}</strong> ${b.address()}`;
    log("announcing...");

    // load messages from previous run
    if (localStorage["bugout-messageboard"]) {
      messages = JSON.parse(localStorage["bugout-messageboard"]);
    }
    if (typeof messages != "object" || !messages["length"]) {
      messages = [];
    }

    /*** rpc calls ***/

    // simple "ping" rpc call
    b.register("ping", function (address, args, cb) {
      args["pong"] = Math.random();
      cb(args);
    });

    /*** messageboard server API ***/

    b.register(
      "post",
      function (address, message, cb) {
        if (typeof message == "string" && message.length < 280) {
          var m = { address: address, m: message, t: new Date().getTime() };
          log("messageboard:", m);
          messages.push(m);
          messages = messages.slice(Math.max(0, messages.length - 10));
          localStorage["bugout-messageboard"] = JSON.stringify(messages);
          cb(true);
          b.send("refresh");
        } else {
          cb(false);
        }
      },
      "Post a message to the board"
    );

    b.register(
      "list",
      function (address, args, cb) {
        cb(messages.slice().reverse());
      },
      "List most recent messages"
    );

    /*** logging ***/

    // log when network connectivity changes
    var connected = false;
    b.on("connections", function (c) {
      if (c == 0 && connected == false) {
        connected = true;
        log("ready");
        // link to the messageboard client URL
        var clientURL =
          document.location.href.replace("server.html", "client.html") + "#" + b.address();
        // qrcode for the client URL
        if (window.innerWidth > 600) {
          // Crea un QR code più bello
          const qrContainer = document.getElementById("qr-container");
          qrContainer.style.display = "block";
          QRCode.toCanvas(
            clientURL,
            {
              width: 180,
              margin: 4,
              color: {
                dark: "#4f46e5",
                light: "#ffffff",
              }
            },
            function (error, canvas) {
              if (error) {
                console.error("Error generating QR code", error);
                return;
              }
              qrContainer.appendChild(canvas);
              
              // Aggiungi il link client sotto il QR code
              const linkElement = document.createElement("div");
              linkElement.style.marginTop = "10px";
              linkElement.style.color = "#374151";
              linkElement.style.fontSize = "0.85em";
              linkElement.innerHTML = `<strong>${translations[currentLang].system.clientLink}</strong><br>${clientURL}`;
              qrContainer.appendChild(linkElement);

              // Aggiungi il badge "Scan"
              const scanBadge = document.createElement("div");
              scanBadge.className = "qr-badge";
              scanBadge.textContent = translations[currentLang].system.scan;
              qrContainer.appendChild(scanBadge);
            }
          );
          
          log(qr(clientURL));
        } else {
          log();
        }
        log(clientURL + "\n");
        log(translations[currentLang].system.connectBack);
      }
      log("connections:", c);
    });

    // log when a client sends a message
    b.on("message", function (address, msg) {
      log("message:", address, msg);
    });

    // log when a client makes an rpc call
    b.on("rpc", function (address, call, args) {
      log("rpc:", address, call, args);
    });

    // log when we see a new client address
    b.on("seen", function (address) {
      log("seen:", address);
    });

    // simple logging function
    function log() {
      var args = Array.prototype.slice.call(arguments);
      console.log.apply(null, args);
      args = args.map(function (a) {
        if (typeof a == "string") return a;
        else return JSON.stringify(a);
      });
      document.getElementById("log").textContent += args.join(" ") + "\n";
    }

    // generate a text based qr code
    function qr(txt) {
      var q = QRCode.create(txt);
      var code = "\n\n";
      for (var i = 0; i < 2; i++) {
        code += "  ████";
        for (var j = 0; j < q.modules.size; j++) {
          code += "██";
        }
        code += "████\n";
      }
      for (var i = 0; i < q.modules.size; i++) {
        code += "  ████";
        for (var j = 0; j < q.modules.size; j++) {
          code += q.modules.data[i * q.modules.size + j] ? "  " : "██";
        }
        code += "████\n";
      }
      for (var i = 0; i < 2; i++) {
        code += "  ████";
        for (var j = 0; j < q.modules.size; j++) {
          code += "██";
        }
        code += "████\n";
      }
      return code + "\n\n";
    }
  </script>
</html>
